<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>集計ちゃん v3.7.1L</title>
<style>
  body { font-family: sans-serif; padding: 15px; line-height: 1.4; background-color: #f9f9f9; color: #333; }
  .table-wrapper { overflow-x: auto; margin-top: 20px; background: white; border: 1px solid #999; -webkit-overflow-scrolling: touch; }
  table { border-collapse: collapse; table-layout: fixed; width: max-content; }
  th, td { border: 1px solid #999; padding: 10px 8px; text-align: center; white-space: nowrap; width: 90px; }
  th { background-color: #eee; position: sticky; top: 0; z-index: 10; cursor: pointer; }
  .dns { color: red; font-weight: bold; }
  .cut { color: blue; text-decoration: line-through; opacity: 0.5; }

  button {
      font-size: 1.0em; padding: 12px 15px; margin: 5px 2px;
      min-width: 120px; cursor: pointer; border-radius: 8px;
      border: 1px solid #666; background-color: #f0f0f0;
      touch-action: manipulation;
  }
  textarea, input[type="text"], input[type="number"] { font-size: 16px !important; }
  
  .modal {
      display:none; position:fixed; top:5%; left:50%; transform:translateX(-50%);
      border:1px solid #999; padding:20px; background:#fff; z-index: 2000;
      width: 85%; max-width: 400px; max-height: 85vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      border-radius: 12px;
  }
  .rank-row { margin-bottom: 10px; display: flex; align-items: center; }
</style>
</head>
<body>

<h3>集計ちゃん <span style="font-size:0.7em;">v3.7.1L</span></h3>

<div style="background:#eee; padding:10px; border-radius:8px;">
  <label>種目: 
    <select id="discipline" onchange="updateTable()">
      <option value="wind">ウインドサーフィン (付則B)</option>
      <option value="yacht">ウイング/ヨット (付則A)</option>
    </select>
  </label>
  <button onclick="document.getElementById('tieBreakModal').style.display='block'" style="min-width:auto; padding:5px 10px; font-size:0.8em; background:#607D8B; color:white; border:none;">タイの解き方</button>
  <br>
  カット設定: 1枚: <input type="number" id="cut1Heat" value="4" style="width:45px;" onchange="updateTable()"> 
  2枚: <input type="number" id="cut2Heat" value="7" style="width:45px;" onchange="updateTable()">
</div>

<div style="margin-top:10px;">
  <button onclick="openPartModal()" style="background:#f44336; color:white; width:100%; max-width:300px;">選手入力（一括）</button>
  <input type="text" id="participantList" placeholder="001 Name, 002 Name" style="width: 100%; margin-top:5px;">
  <div id="participantCount" style="font-weight:bold; margin:5px 0; color:#2196F3;">0名 登録中</div>
  <button onclick="applyParticipantsFromInput()" style="background:#FF9800; color:white; width:100%; max-width:300px; font-weight:bold;">表を更新・再計算</button>
</div>

<hr>
<button onclick="openManualHeat()" style="background-color: #9C27B0; color:white; border:none; width:100%; max-width:300px;">ヒート順位を手入力</button>

<div id="tableContainer"></div>

<div id="partModal" class="modal">
    <h3>選手入力</h3>
    <textarea id="partTextArea" style="width:100%; height:200px;" placeholder="001 Taro&#13;&#10;002 Hanako"></textarea>
    <button onclick="submitPartModal()" style="width:100%; background:#4CAF50; color:white; padding:15px; border:none;">反映する</button>
    <button style="width:100%; margin-top:10px;" onclick="closePartModal()">閉じる</button>
</div>

<div id="manualHeatModal" class="modal">
    <h3 id="manualHeatModalTitle">順位入力</h3>
    <div id="manualHeatInputs"></div>
    <button onclick="addRankInput()" style="width:100%; background:#eee; border:1px dashed #999; margin-top:5px;">+ 順位を追加</button>
    <button onclick="submitManualHeat()" style="width:100%; background:#4CAF50; color:white; margin-top:15px; padding:15px; border:none; font-weight:bold;">確定保存</button>
    <button style="width:100%; margin-top:10px;" onclick="closeManualHeatModal()">キャンセル</button>
</div>

<div id="heatActionModal" class="modal">
    <h3 id="heatActionTitle">操作</h3>
    <button style="width:100%; background:#4CAF50; color:white; padding:15px;" onclick="startHeatEdit()">修正する</button>
    <button style="width:100%; background:#f44336; color:white; padding:15px; margin-top:10px;" onclick="confirmDeleteHeat()">削除する</button>
    <button style="width:100%; margin-top:15px;" onclick="closeHeatActionModal()">キャンセル</button>
</div>

<div id="tieBreakModal" class="modal">
    <h3>タイ（同点）の解き方</h3>
    <p><strong>RRS付則A（ヨット、ウイング）</strong><br>
    → カットを含まない得点を良順に比較 → カットを含め最終レースから逆順に比較</p>
    <hr>
    <p><strong>付則B（ウインドサーフィン）</strong><br>
    → カットされた得点を比較 → カット含む得点を良順に比較 → カット含め最終レースから逆順に比較</p>
    <button onclick="this.parentElement.style.display='none'" style="width:100%; padding:10px; margin-top:10px;">閉じる</button>
</div>

<script>
let results = {}; let participants = []; let heats = []; let displayOrder = [];
let targetHeatIndex = -1; let isEditMode = false;

function openPartModal() {
    const list = document.getElementById('participantList').value;
    document.getElementById('partTextArea').value = list.split(',').map(s=>s.trim()).filter(s=>s).join('\n');
    document.getElementById('partModal').style.display = 'block';
}
function closePartModal() { document.getElementById('partModal').style.display = 'none'; }
function submitPartModal() {
    const text = document.getElementById('partTextArea').value;
    document.getElementById('participantList').value = text.split('\n').filter(s=>s.trim()!=='').join(', ');
    applyParticipantsFromInput();
    closePartModal();
}

function applyParticipantsFromInput(){
    const text = document.getElementById('participantList').value.trim();
    if(!text) { participants=[]; displayOrder=[]; updateTable(); return; }
    const rawList = text.split(',').map(s=>s.trim()).filter(s=>s!=='');
    participants = rawList.map(item => {
        const firstSpace = item.search(/\s/);
        const no = (firstSpace === -1) ? item : item.substring(0, firstSpace).trim();
        return { no: no, fullName: item.trim() };
    });
    const dns = participants.length + 1;
    participants.forEach(p => { if(!results[p.no]) results[p.no] = Array(heats.length).fill(dns); });
    displayOrder = [...participants];
    document.getElementById('participantCount').textContent = `${participants.length}名 登録中`;
    updateTable();
}

function openManualHeat(){
    const container = document.getElementById('manualHeatInputs');
    container.innerHTML = ''; 
    if(isEditMode) {
        document.getElementById('manualHeatModalTitle').textContent = `Heat ${targetHeatIndex+1} 修正`;
        let entries = participants.map(p => ({no: p.no, r: results[p.no][targetHeatIndex]}))
                                  .filter(e => e.r <= participants.length).sort((a,b)=>a.r-b.r);
        if(entries.length > 0) { entries.forEach(e => addRankInput(e.no)); } else { addRankInput(); }
    } else {
        document.getElementById('manualHeatModalTitle').textContent = `新規ヒート入力`;
        addRankInput(); 
    }
    document.getElementById('manualHeatModal').style.display = 'block';
}

function addRankInput(pNo = ""){
    const container = document.getElementById('manualHeatInputs');
    const rank = container.querySelectorAll('.rank-row').length + 1;
    const div = document.createElement('div');
    div.className = 'rank-row';
    div.innerHTML = `<span style="width:50px; font-weight:bold;">${rank}位:</span> 
                     <input type="text" class="mRankInput" value="${pNo}" 
                            style="width:120px; padding:8px;" inputmode="numeric"
                            onkeydown="if(event.key==='Enter'){event.preventDefault();addRankInput();}">`;
    container.appendChild(div);
    div.querySelector('input').focus();
}

function submitManualHeat(){
    if(document.activeElement) document.activeElement.blur();
    setTimeout(() => {
        const inputs = document.getElementsByClassName('mRankInput');
        const pts = {};
        let rankCounter = 1;
        for (let i = 0; i < inputs.length; i++) {
            const val = inputs[i].value.trim();
            if (val !== "") { pts[val] = rankCounter; rankCounter++; }
        }
        const dns = participants.length + 1;
        if(isEditMode){ 
            participants.forEach(p => { results[p.no][targetHeatIndex] = pts[p.no] || dns; }); 
        } else { 
            heats.push("H" + (heats.length + 1)); 
            participants.forEach(p => { 
                if(!results[p.no]) results[p.no] = Array(heats.length - 1).fill(dns);
                results[p.no].push(pts[p.no] || dns); 
            }); 
        }
        updateTable(); closeManualHeatModal();
    }, 50);
}

function closeManualHeatModal(){ document.getElementById('manualHeatModal').style.display='none'; isEditMode=false; }

function updateTable(){
    const discipline = document.getElementById('discipline').value;
    const c1 = parseInt(document.getElementById('cut1Heat').value) || 99;
    const c2 = parseInt(document.getElementById('cut2Heat').value) || 99;
    const dns = participants.length + 1;

    let scoringData = participants.map(p => {
        let pts = (results[p.no] || []).map(v => (v > participants.length ? dns : v));
        let sorted = [...pts].sort((a,b)=>b-a);
        let cutCount = (pts.length >= c2) ? 2 : (pts.length >= c1 ? 1 : 0);
        let cutVals = sorted.slice(0, cutCount);
        let total = pts.reduce((a,b)=>a+b, 0);
        let net = total - cutVals.reduce((a,b)=>a+b, 0);
        return { no: p.no, fullName: p.fullName, pts, total, net, cutVals: [...cutVals] };
    });

    // ソートロジック
    scoringData.sort((a, b) => {
        if (a.net !== b.net) return a.net - b.net;
        if (discipline === 'wind') {
            // 付則B: カットされた得点の比較 -> 全得点の良順比較
            let a_cuts = [...a.cutVals].sort((x,y)=>y-x);
            let b_cuts = [...b.cutVals].sort((x,y)=>y-x);
            for(let i=0; i<a_cuts.length; i++){
                if(a_cuts[i] !== b_cuts[i]) return a_cuts[i] - b_cuts[i];
            }
            let a_all = [...a.pts].sort((x,y)=>x-y);
            let b_all = [...b.pts].sort((x,y)=>x-y);
            for(let i=0; i<a_all.length; i++){
                if(a_all[i] !== b_all[i]) return a_all[i] - b_all[i];
            }
        } else {
            // 付則A: カット前合計（Total）比較
            if (a.total !== b.total) return a.total - b.total;
        }
        return (b.pts[b.pts.length-1] || 0) - (a.pts[a.pts.length-1] || 0);
    });

    displayOrder = scoringData;

    let html = `<table><tr><th>順位</th><th>No.</th><th>Name</th>`;
    heats.forEach((h, i) => html += `<th onclick="openHeatActionModal(${i})">${h}</th>`);
    html += `<th>total</th><th>cut1</th><th>cut2</th><th>Net</th></tr>`;

    displayOrder.forEach((r, idx) => {
        html += `<tr><td>${idx+1}</td><td>${r.no}</td><td style="text-align:left; font-size:0.8em;">${r.fullName.replace(r.no,'').trim()}</td>`;
        let curCuts = [...r.cutVals];
        r.pts.forEach(pt => {
            let ci = curCuts.indexOf(pt);
            if(ci > -1) { curCuts.splice(ci,1); html += `<td class="cut">${pt}</td>`; }
            else { html += `<td class="${pt>=dns?'dns':''}">${pt}</td>`; }
        });
        // Total, Cuts, Net
        html += `<td>${r.total}</td>`;
        html += `<td class="cut">${r.cutVals[0] || ''}</td>`;
        html += `<td class="cut">${r.cutVals[1] || ''}</td>`;
        html += `<td style="font-weight:bold; background:#fff9c4;">${r.net}</td></tr>`;
    });
    document.getElementById('tableContainer').innerHTML = `<div class="table-wrapper">${html}</table></div>`;
}

function openHeatActionModal(i) { targetHeatIndex = i; document.getElementById('heatActionModal').style.display='block'; }
function closeHeatActionModal() { document.getElementById('heatActionModal').style.display='none'; }
function startHeatEdit() { isEditMode = true; closeHeatActionModal(); openManualHeat(); }
function confirmDeleteHeat() {
    if(confirm(`Heat ${targetHeatIndex+1}を削除しますか？`)) {
        heats.splice(targetHeatIndex, 1);
        for(let no in results) results[no].splice(targetHeatIndex, 1);
        updateTable();
    }
    closeHeatActionModal();
}
window.onload = applyParticipantsFromInput;
</script>
</body>
</html>