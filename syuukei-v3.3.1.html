<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>集計ちゃん v3.3.1</title>
<style>


  /* ボタン色 */
  #handleCSVBtn { background-color: #4CAF50; color: white; }  /* 緑 */
  #downloadCSVBtn { background-color: #2196F3; color: white; } /* 青 */
  #recalcBtn { background-color: #FF9800; color: white; }      /* オレンジ */





  body { font-family: sans-serif; padding: 20px; }
  .table-wrapper { overflow-x: auto; }
  table { 
      border-collapse: collapse; 
      table-layout: fixed;
      width: max-content;
  }
  th, td { 
      border: 1px solid #999; 
      padding: 5px 10px; 
      text-align: center; 
      white-space: nowrap; 
      width: 80px; 
  }
  th { background-color: #eee; cursor: pointer; }
  .dns { color: red; font-weight: bold; }
  .cut { color: blue; font-weight: bold; }

  button {
      font-size: 1.2em;
      padding: 14px 24px;
      margin: 5px 5px;
      min-width: 140px;
      cursor: pointer;
      border-radius: 6px;
      border: 1px solid #666;
      background-color: #f0f0f0;
  }
  button:active { background-color: #ddd; }

  select, input[type="text"], input[type="number"] {
      font-size: 1.1em;
      padding: 10px;
      min-width: 140px;
      margin: 5px 5px;
      border-radius: 5px;
      border: 1px solid #999;
      box-sizing: border-box;
  }

  input[type="file"] { display: none; }
</style>
</head>
<body>

<h2>集計ちゃん  <span style="font-size:0.7em;">by Popolo v3.3.1</span></h2>

<label>種目: 
  <select id="discipline">
    <option value="yacht">ヨット／ウイングフォイル</option>
    <option value="wind">ウインドサーフィン</option>
  </select>
</label>
<br><br>

<label>カット設定（ヒート数を入力）:</label><br>
1カットヒート: <input type="number" id="cut1Heat" placeholder="例: 4" style="width:80px; text-align:center;">
2カットヒート: <input type="number" id="cut2Heat" placeholder="例: 8" style="width:80px; text-align:center;">
<br><br>

<label>参加選手番号（カンマ区切り）:</label>
<input type="text" id="participantList" placeholder="001,002,003,004">
<span id="participantCount" style="margin-left:10px;">0名</span>
<br><br>

<!-- 参加者CSV読み取り -->
<button id="loadParticipantBtn">参加選手リストの読取</button>
<input type="file" id="participantCSV" accept=".csv">

<br><br>

<!-- ヒートCSV -->
<button id="csvFileBtn">CSVファイルを選択</button>
<input type="file" id="csvFile" accept=".csv">




<button id="handleCSVBtn" onclick="handleCSV()">ヒート追加</button>
<button id="downloadCSVBtn" onclick="downloadCSV()">総合結果をCSV出力</button>
<button id="recalcBtn" onclick="updateTable()">再計算</button>

<div id="tableContainer"></div>

<script>
let results = {};
let heats = [];
let cutSettings = {};
let participants = [];
let seriesCount = 0;
let currentSortAsc = true;

// --- 参加者CSV読取 ---
document.getElementById('loadParticipantBtn').addEventListener('click', () => {
    document.getElementById('participantCSV').click();
});
document.getElementById('participantCSV').addEventListener('change', () => {
    const fileInput = document.getElementById('participantCSV');
    if(!fileInput.files.length){ alert('CSVを選択してください'); return; }

    const reader = new FileReader();
    reader.onload = function(e){
        const lines = e.target.result.trim().split(/\r?\n/);
        if(lines.length < 2){ alert('CSVの内容が不十分です'); return; }
        const participantsArr = [];
        for(let i=1; i<lines.length; i++){ // 1行目ヘッダーをスキップ
            const cols = lines[i].split(',');
            if(cols.length < 1) continue;
            const number = cols[0].trim();
            if(number) participantsArr.push(number);
        }
        document.getElementById('participantList').value = participantsArr.join(',');
        document.getElementById('participantCount').textContent = `${participantsArr.length}名`;
    };
    reader.readAsText(fileInput.files[0], 'utf-8');
});

// --- ヒートCSV選択ボタン ---
document.getElementById('csvFileBtn').addEventListener('click', () => {
    document.getElementById('csvFile').click();
});

// --- CSV処理 ---
function handleCSV(){
    const fileInput = document.getElementById('csvFile');
    if(!fileInput.files.length){ alert('CSVを選択してください'); return; }
    const participantText = document.getElementById('participantList').value.trim();
    if(!participantText){ alert('参加選手番号を入力してください'); return; }
    participants = participantText.split(',').map(s=>s.trim());
    seriesCount = participants.length;
    participants.forEach(name=>{ if(!results[name]) results[name] = Array(heats.length).fill(seriesCount + 1); });

    const reader = new FileReader();
    reader.onload = function(e){
        parseCSV(e.target.result);
        updateTable();
    };
    reader.readAsText(fileInput.files[0], 'utf-8');
}

// --- CSV解析 ---
function parseCSV(text){
    const lines = text.trim().split(/\r?\n/);
    if(lines.length < 2) return;
    let heatName = "Heat" + (heats.length + 1);
    heats.push(heatName);
    let heatPoints = {};
    for(let i=1;i<lines.length;i++){ // 1行目はヘッダーとして無視
        const cols = lines[i].split(',');
        if(cols.length < 3) continue;
        const rankStr = cols[1].trim();
        const colorNumber = cols[2].trim();
        if(!participants.includes(colorNumber)) continue;
        let rank = parseInt(rankStr,10);
        heatPoints[colorNumber] = !isNaN(rank) ? rank : seriesCount + 1;
    }
    participants.forEach(name=>{
        if(!results[name]) results[name] = Array(heats.length - 1).fill(seriesCount + 1);
        results[name].push(heatPoints[name] !== undefined ? heatPoints[name] : seriesCount + 1);
    });
}

// --- ネットポイント計算 ---
function getCutCount(heatCount){
    let count = 0;
    for(let key of Object.keys(cutSettings).sort((a,b)=>a-b)){
        if(heatCount >= key) count = cutSettings[key];
    }
    return count;
}

function calculateNetPoints(){
    let netResults = {};
    const discipline = document.getElementById('discipline').value;
    for(let name of participants){
        let points = results[name].slice();
        let cutCount = getCutCount(points.length);
        let cuts = [];
        if(cutCount > 0){
            let sorted = points.map((p,i)=>({p,i})).sort((a,b)=>b.p - a.p);
            cuts = sorted.slice(0,cutCount).map(c=>c.p);
        }
        let totalPoints = points.reduce((a,b)=>a+b,0);
        let netPoints = totalPoints - cuts.reduce((a,b)=>a+b,0);
        netResults[name] = {points, cuts, net: netPoints, total: totalPoints};
    }
    let sortedNames = participants.slice();
    sortedNames.sort((a,b)=>{
        let na = netResults[a].net;
        let nb = netResults[b].net;
        if(na !== nb) return na - nb;
        return 0;
    });
    let rank = 1;
    let finalResults = {};
    sortedNames.forEach(name=>{ finalResults[name] = {...netResults[name], rank: rank++}; });
    return finalResults;
}

// --- 表更新 ---
function updateTable(){
    cutSettings = {};
    const cut1 = parseInt(document.getElementById('cut1Heat').value);
    const cut2 = parseInt(document.getElementById('cut2Heat').value);
    if(!isNaN(cut1)) cutSettings[cut1] = 1;
    if(!isNaN(cut2)) cutSettings[cut2] = 2;

    const finalResults = calculateNetPoints();
    let html = "<table id='resultsTable'><tr>";
    html += "<th>順位</th><th>選手名</th>";
    heats.forEach(h=>html += `<th>${h}</th>`);
    html += "<th>カット前合計</th>";
    let maxCut = Math.max(...Object.values(cutSettings),0);
    for(let i=1;i<=maxCut;i++){ html += `<th>カット${i}</th>`; }
    html += "<th>Net</th></tr>";

    for(let name of participants){
        let r = finalResults[name];
        html += `<tr><td>${r.rank}</td><td>${name}</td>`;
        r.points.forEach(p=>{ html += `<td>${p === seriesCount + 1 ? "<span class='dns'>"+p+"</span>" : p}</td>`; });
        html += `<td>${r.total}</td>`;
        for(let i=0;i<maxCut;i++){ html += `<td>${r.cuts[i] !== undefined ? "<span class='cut'>"+r.cuts[i]+"</span>":""}</td>`; }
        html += `<td>${r.net}</td></tr>`;
    }
    document.getElementById('tableContainer').innerHTML = "<div class='table-wrapper'>"+html+"</div>";
}

// --- 再計算ボタン ---
function recalculate(){
    if(participants.length === 0){ alert('参加選手がいません'); return; }
    if(heats.length === 0){ alert('ヒートデータがありません'); return; }
    updateTable();
}

// --- CSV出力 ---
function downloadCSV(){
    const finalResults = calculateNetPoints();
    let csv = "順位,選手名,カット前合計," + heats.join(",") + ",カット,Net\n";
    for(let name of participants){
        let r = finalResults[name];
        csv += `${r.rank},${name},${r.total},${r.points.join(",")},(${r.cuts.join(',')}),${r.net}\n`;
    }
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "総合結果_v3.2.1.csv";
    a.click();
    URL.revokeObjectURL(url);
}
</script>

</body>
</html>

