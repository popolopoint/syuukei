<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>集計ちゃん by Popolo v3.6.6g</title>
<style>
  body { font-family: sans-serif; padding: 20px; line-height: 1.4; background-color: #f9f9f9; }
  .table-wrapper { overflow-x: auto; margin-top: 20px; }
  table { border-collapse: collapse; table-layout: fixed; width: max-content; background: white; }
  th, td { border: 1px solid #999; padding: 8px 10px; text-align: center; white-space: nowrap; width: 80px; }
  th { background-color: #eee; cursor: pointer; }
  .dns { color: red; font-weight: bold; }
  .cut { color: blue; font-weight: bold; }

  button {
      font-size: 1.1em; padding: 12px 20px; margin: 5px;
      min-width: 140px; cursor: pointer; border-radius: 6px;
      border: 1px solid #666; background-color: #f0f0f0;
      touch-action: manipulation;
  }
  button:active { background-color: #ddd; }

  select, input[type="text"], input[type="number"] {
      font-size: 1.1em; padding: 10px; min-width: 140px;
      margin: 5px; border-radius: 5px; border: 1px solid #999;
  }

  input[type="file"] { display: none; }

  #handleCSVBtn { background-color: #4CAF50; color: white; }
  #downloadCSVBtn { background-color: #2196F3; color: white; }
  #recalcBtn { background-color: #FF9800; color: white; }
  #manualHeatBtn { background-color: #9C27B0; color: white; width: 100%; max-width: 300px; }

  /* モーダル共通設定 */
  .modal {
      display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%);
      border:1px solid #999; padding:20px; background:#fff; z-index: 2000;
      width: 85%; max-width: 320px; max-height: 80vh; overflow-y: auto;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3); border-radius: 10px;
  }
  .modal h3 { margin-top: 0; font-size: 1.2em; }
  .modal button { width: 100%; margin: 8px 0; }
</style>
</head>
<body>

<h2>集計ちゃん <span style="font-size:0.7em;">by Popolo v3.6.6g</span></h2>

<div style="background:#eee; padding:10px; border-radius:8px;">
  <label>種目: 
    <select id="discipline">
      <option value="wind">ウインドサーフィン</option>
      <option value="yacht">ウイングフォイル/ヨット</option>
    </select>
  </label>
  <button onclick="document.getElementById('tieBreakModal').style.display='block'" 
          style="min-width:auto; padding:8px 12px; font-size:0.9em; background:#607D8B; color:white; border:none;">
    タイの解き方
  </button>
</div>

<br>
<label>カット設定（ヒート数を入力）:</label><br>
1カット: <input type="number" id="cut1Heat" value="4" style="width:70px; text-align:center;">
2カット: <input type="number" id="cut2Heat" value="7" style="width:70px; text-align:center;">
<br><br>

<button id="manualParticipantBtn" onclick="openParticipantModal()" style="background-color: #f44336; color: white;">選手手入力</button>

<br>
<label>参加選手番号（カンマ区切り）:</label><br>
<input type="text" id="participantList" placeholder="001,002,003" style="width:90%;">
<span id="participantCount" style="font-weight:bold;">0名</span>

<br><br>
<button id="manualHeatBtn" onclick="openManualHeat()">ヒート手入力（反映用）</button>
<br>

<label>結果名（ファイル名）:</label>
<input type="text" id="resultName" placeholder="例: 大会名" style="width:180px;">
<br><br>

<button id="downloadCSVBtn" onclick="downloadCSV()">CSV出力</button>
<button id="recalcBtn" onclick="updateTable()">再計算</button>

<div id="tableContainer"></div>

<div id="tieBreakModal" class="modal">
    <h3>タイ（同点）の解き方</h3>
    <p style="font-size:0.9em;">
        <strong>RRS付則A（ヨット、ウイング）</strong><br>
        → カットを含まない得点を良順に比較 → カットを含め最終レースから逆順に比較
    </p>
    <hr>
    <p style="font-size:0.9em;">
        <strong>付則B（ウインドサーフィン）</strong><br>
        → カットされた得点を比較 → カット含む得点を良順に比較 → カット含め最終レースから逆順に比較
    </p>
    <button onclick="this.parentElement.style.display='none'">閉じる</button>
</div>

<div id="manualHeatModal" class="modal">
    <h3>ヒート入力</h3>
    <div id="manualHeatInputs"></div>
    <button id="manualAddBtn">着順を追加</button>
    <button onclick="submitManualHeat()" style="background:#4CAF50; color:white;">確定保存</button>
    <button onclick="closeManualHeatModal()">キャンセル</button>
</div>

<div id="participantModal" class="modal">
    <h3>選手番号の入力</h3>
    <div id="participantInputs"></div>
    <button id="partAddBtn" onclick="addParticipantInput()">次を追加</button>
    <button onclick="submitParticipants()" style="background-color: #4CAF50; color: white;">確定</button>
    <button onclick="closeParticipantModal()">キャンセル</button>
</div>

<script>
let results = {}; let heats = []; let cutSettings = {};
let participants = []; let seriesCount = 0; let displayOrder = [];
let currentSortAsc = true;

function applyParticipantsFromInput(){
    const text = document.getElementById('participantList').value.trim();
    if(!text){ participants=[]; displayOrder=[]; seriesCount=0; document.getElementById('participantCount').textContent="0名"; return; }
    const updated = text.split(',').map(s=>s.trim()).filter(s=>s!=='');
    const newCount = updated.length;
    updated.forEach(id=>{
        if(!results[id]) results[id] = Array(heats.length).fill(newCount + 1);
    });
    participants = updated.slice(); displayOrder = participants.slice();
    seriesCount = newCount;
    document.getElementById('participantCount').textContent = `${participants.length}名`;
    updateTable();
}

function openManualHeat(){
    applyParticipantsFromInput();
    if(participants.length === 0){ alert('選手リストが空です'); return; }
    const container = document.getElementById('manualHeatInputs');
    container.innerHTML = ''; manualNextRank = 1; addManualRankInput();
    document.getElementById('manualHeatModal').style.display = 'block';
}

function addManualRankInput(){
    const container = document.getElementById('manualHeatInputs');
    const div = document.createElement('div');
    div.style.marginBottom = "5px";
    div.innerHTML = `${manualNextRank}位: <input type="text" class="manualRankInput" style="width:100px;" inputmode="numeric">`;
    container.appendChild(div);
    const input = div.querySelector('input');
    input.focus();
    input.addEventListener('keydown', e => {
        if(e.key === 'Enter'){ e.preventDefault(); if(input.value.trim()!=='') addManualRankInput(); }
    });
    manualNextRank++;
}

function submitManualHeat(){
    // 最後の一人の入力漏れを防ぐためフォーカスを強制解除
    if(document.activeElement) document.activeElement.blur();
    
    setTimeout(() => {
        const inputs = Array.from(document.querySelectorAll('.manualRankInput'));
        const heatName = "Heat" + (heats.length + 1);
        heats.push(heatName);
        const heatPoints = {};
        inputs.forEach((input, idx) => {
            const val = input.value.trim();
            if(val && participants.includes(val)) heatPoints[val] = idx + 1;
        });
        participants.forEach(p => {
            if(!results[p]) results[p] = Array(heats.length - 1).fill(seriesCount + 1);
            results[p].push(heatPoints[p] || (seriesCount + 1));
        });
        updateTable();
        closeManualHeatModal();
    }, 100);
}

function closeManualHeatModal(){ document.getElementById('manualHeatModal').style.display = 'none'; }

function updateTable(){
    cutSettings = {};
    const c1 = parseInt(document.getElementById('cut1Heat').value);
    const c2 = parseInt(document.getElementById('cut2Heat').value);
    if(!isNaN(c1)) cutSettings[c1] = 1;
    if(!isNaN(c2)) cutSettings[c2] = 2;

    const netResults = calculateNetPoints();
    let html = "<table><tr><th onclick='sortTableByColumn(0)'>順位</th><th>No.</th>";
    heats.forEach((h,i)=> html += `<th onclick="deleteHeat(${i})">${h}</th>`);
    html += "<th>Total</th>";
    let maxCut = Math.max(...Object.values(cutSettings), 0);
    for(let i=1; i<=maxCut; i++) html += `<th>cut${i}</th>`;
    html += "<th>Net</th></tr>";

    displayOrder.forEach((name, idx) => {
        const r = netResults[name];
        html += `<tr><td>${idx+1}</td><td>${name}</td>`;
        r.points.forEach(p => {
            html += `<td>${p > seriesCount ? '<span class="dns">'+p+'</span>' : p}</td>`;
        });
        html += `<td>${r.total}</td>`;
        for(let i=0; i<maxCut; i++){
            html += `<td>${r.cuts[i] !== undefined ? '<span class="cut">'+r.cuts[i]+'</span>' : ''}</td>`;
        }
        html += `<td style="background:#fff9c4; font-weight:bold;">${r.net}</td></tr>`;
    });
    document.getElementById('tableContainer').innerHTML = "<div class='table-wrapper'>" + html + "</table></div>";
}

function calculateNetPoints(){
    let netResults = {};
    const discipline = document.getElementById('discipline').value;
    participants.forEach(name => {
        let pts = (results[name] || []).slice();
        let cutCount = 0;
        const sortedKeys = Object.keys(cutSettings).map(Number).sort((a,b)=>a-b);
        for(let k of sortedKeys){ if(pts.length >= k) cutCount = cutSettings[k]; }
        
        let sortedForCut = pts.map((p,i)=>({p,i})).sort((a,b)=>b.p - a.p);
        let cuts = [], cutIndices = new Set();
        for(let i=0; i<cutCount; i++){ if(sortedForCut[i]) cutIndices.add(sortedForCut[i].i); }
        
        let total = pts.reduce((a,b)=>a+b, 0);
        let kept = [];
        pts.forEach((p, i) => { if(cutIndices.has(i)) cuts.push(p); else kept.push(p); });
        
        netResults[name] = {
            points: pts, cuts: cuts.sort((a,b)=>b-a), net: total - cuts.reduce((a,b)=>0+a+b, 0),
            total: total, keptSorted: kept.sort((a,b)=>a-b), 
            cutsSorted: cuts.slice().sort((a,b)=>a-b),
            allSorted: pts.slice().sort((a,b)=>a-b)
        };
    });
    return netResults;
}

function sortTableByColumn(colIndex){
    const netResults = calculateNetPoints();
    const discipline = document.getElementById('discipline').value;
    displayOrder.sort((a,b) => {
        const rA = netResults[a], rB = netResults[b];
        if(rA.net !== rB.net) return currentSortAsc ? rA.net - rB.net : rB.net - rA.net;
        let tie = 0;
        if(discipline === 'yacht'){
            tie = compareArrays(rA.keptSorted, rB.keptSorted);
        } else {
            tie = compareArrays(rA.cutsSorted, rB.cutsSorted);
            if(tie === 0) tie = compareArrays(rA.allSorted, rB.allSorted);
        }
        if(tie !== 0) return currentSortAsc ? tie : -tie;
        return (rB.points[rB.points.length-1]||0) - (rA.points[rA.points.length-1]||0);
    });
    updateTable();
    currentSortAsc = !currentSortAsc;
}

function compareArrays(a, b){
    const len = Math.max(a.length, b.length);
    for(let i=0; i<len; i++){
        let vA = a[i] === undefined ? Infinity : a[i];
        let vB = b[i] === undefined ? Infinity : b[i];
        if(vA !== vB) return vA - vB;
    }
    return 0;
}

function deleteHeat(index){
    if(!confirm(`ヒート ${index+1} を削除しますか？`)) return;
    heats.splice(index, 1);
    for(let n in results) results[n].splice(index, 1);
    updateTable();
}

function downloadCSV(){
    const netResults = calculateNetPoints();
    let csv = "順位,No.," + heats.join(",") + ",Total,Net\n";
    displayOrder.forEach((name, i) => {
        const r = netResults[name];
        csv += `${i+1},${name},${r.points.join(",")},${r.total},${r.net}\n`;
    });
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = (document.getElementById('resultName').value || "結果") + ".csv";
    a.click();
}

function openParticipantModal() {
    const container = document.getElementById('participantInputs');
    container.innerHTML = ''; addParticipantInput();
    document.getElementById('participantModal').style.display = 'block';
}
function addParticipantInput() {
    const container = document.getElementById('participantInputs');
    const div = document.createElement('div');
    div.innerHTML = `${container.querySelectorAll('input').length+1}: <input type="text" class="manualPartInput" style="width:100px;" inputmode="numeric">`;
    container.appendChild(div);
    const input = div.querySelector('input'); input.focus();
    input.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); if(input.value.trim()!=='') addParticipantInput(); } });
}
function submitParticipants() {
    const inputs = Array.from(document.querySelectorAll('.manualPartInput'));
    const newVals = inputs.map(i => i.value.trim()).filter(v => v !== '');
    if(newVals.length > 0) { document.getElementById('participantList').value = newVals.join(','); applyParticipantsFromInput(); }
    closeParticipantModal();
}
function closeParticipantModal(){ document.getElementById('participantModal').style.display='none'; }

document.getElementById('participantList').addEventListener('blur', applyParticipantsFromInput);
document.getElementById('manualAddBtn').addEventListener('click', addManualRankInput);

applyParticipantsFromInput();
</script>
</body>
</html>