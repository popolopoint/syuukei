<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>集計ちゃん v3.7.1R</title>
<style>
  body { font-family: sans-serif; padding: 15px; line-height: 1.4; background-color: #f9f9f9; color: #333; }
  .table-wrapper { overflow-x: auto; margin-top: 20px; background: white; border: 1px solid #999; -webkit-overflow-scrolling: touch; }
  table { border-collapse: collapse; table-layout: fixed; width: max-content; }
  th, td { border: 1px solid #999; padding: 10px 8px; text-align: center; white-space: nowrap; width: 90px; }
  th { background-color: #eee; position: sticky; top: 0; z-index: 10; cursor: pointer; }
  .dns { color: red; font-weight: bold; }
  .cut { color: blue; font-weight: bold; opacity: 0.7; }

  .save-panel { background:#e3f2fd; padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid #2196F3; }
  .control-panel { background:#eee; padding:10px; border-radius:8px; margin-bottom:10px; }

  button {
      font-size: 1.0em; padding: 12px 15px; margin: 5px 2px;
      min-width: 120px; cursor: pointer; border-radius: 8px;
      border: 1px solid #666; background-color: #f0f0f0;
      touch-action: manipulation;
  }
  .modal {
      display:none; position:fixed; top:5%; left:50%; transform:translateX(-50%);
      border:1px solid #999; padding:20px; background:#fff; z-index: 2000;
      width: 85%; max-width: 400px; max-height: 85vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      border-radius: 12px;
  }
  .rank-row { margin-bottom: 10px; display: flex; align-items: center; }
  .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
  textarea { width: 100%; height: 150px; font-size: 16px; margin-bottom: 10px; }
</style>
</head>
<body>

<h3>集計ちゃん <span style="font-size:0.7em;">v3.7.1R</span></h3>

<div class="save-panel">
  <strong style="color:#1976D2;">データ管理:</strong><br>
  <button onclick="saveToFile()" style="background:#2196F3; color:white; min-width:100px; padding:8px;">ファイル保存</button>
  <button onclick="document.getElementById('fileInput').click()" style="background:#4CAF50; color:white; min-width:100px; padding:8px;">ファイル読込</button>
  <button onclick="clearAllData()" style="background:#f44336; color:white; min-width:80px; padding:8px; font-size:0.8em;">全消去</button>
  <input type="file" id="fileInput" style="display:none" onchange="loadFromFile(event)">
</div>

<div class="control-panel">
  <label>種目: 
    <select id="discipline" onchange="updateTable(); saveToLocal();">
      <option value="wind">ウインドサーフィン (付則B)</option>
      <option value="yacht">ウイング/ヨット (付則A)</option>
    </select>
  </label>
  <button onclick="document.getElementById('tieBreakModal').style.display='block'" style="min-width:auto; padding:5px 10px; font-size:0.8em; background:#607D8B; color:white; border:none;">タイの解き方</button>
  <br>
  カット: 1枚: <input type="number" id="cut1Heat" value="4" style="width:45px;" onchange="updateTable(); saveToLocal();"> 
  2枚: <input type="number" id="cut2Heat" value="7" style="width:45px;" onchange="updateTable(); saveToLocal();">
</div>

<div style="margin-top:10px;">
  <button onclick="openPartModal()" style="background:#f44336; color:white; width:100%; max-width:300px;">選手入力（一括）</button>
  <input type="text" id="participantList" placeholder="001 Name, 002 Name" style="width: 100%; margin-top:5px;" onblur="applyParticipantsFromInput(); saveToLocal();">
  <div id="participantCount" style="font-weight:bold; margin:5px 0; color:#2196F3;">0名 登録中</div>
</div>

<hr>
<button onclick="openManualHeat()" style="background-color: #9C27B0; color:white; border:none; width:100%; max-width:300px;">ヒート順位を手入力</button>

<div id="tableContainer"></div>

<div id="partModal" class="modal">
    <h3>選手入力</h3>
    <textarea id="partTextArea" placeholder="001 選手名&#10;002 選手名"></textarea>
    <button onclick="submitPartModal()" style="width:100%; background:#4CAF50; color:white; padding:15px; border:none;">反映する</button>
    <button style="width:100%; margin-top:10px;" onclick="closePartModal()">閉じる</button>
</div>

<div id="manualHeatModal" class="modal">
    <h3 id="manualHeatModalTitle">順位入力</h3>
    <div id="manualHeatInputs"></div>
    <button onclick="addRankInput()" style="width:100%; background:#eee; border:1px dashed #999; margin-top:5px;">+ 順位を追加</button>
    <button onclick="submitManualHeat()" style="width:100%; background:#4CAF50; color:white; margin-top:15px; padding:15px; border:none; font-weight:bold;">確定保存</button>
    <button style="width:100%; margin-top:10px;" onclick="closeManualHeatModal()">キャンセル</button>
</div>

<div id="heatActionModal" class="modal">
    <h3 id="heatActionTitle">操作</h3>
    <div class="action-grid">
        <button style="background:#2196F3; color:white;" onclick="moveHeat(-1)">← 左へ移動</button>
        <button style="background:#2196F3; color:white;" onclick="moveHeat(1)">右へ移動 →</button>
    </div>
    <hr>
    <button style="width:100%; background:#4CAF50; color:white; padding:12px;" onclick="startHeatEdit()">修正する</button>
    <button style="width:100%; background:#f44336; color:white; padding:12px; margin-top:10px;" onclick="confirmDeleteHeat()">削除する</button>
    <button style="width:100%; margin-top:15px;" onclick="closeHeatActionModal()">閉じる</button>
</div>

<div id="tieBreakModal" class="modal">
    <h3>タイの解き方</h3>
    <p><strong>付則A（ヨット/ウイング）</strong><br>合計得点比較 → 最終レース逆順</p>
    <hr>
    <p><strong>付則B（ウインド）</strong><br>カット得点比較 → 全レース良順比較 → 最終レース逆順</p>
    <button onclick="this.parentElement.style.display='none'" style="width:100%; padding:10px;">閉じる</button>
</div>

<script>
let results = {}; let participants = []; let heats = []; 
let targetHeatIndex = -1; let isEditMode = false;

// --- 保存・読込ロジック ---
function saveToLocal() {
    const data = {
        results, heats,
        participantList: document.getElementById('participantList').value,
        discipline: document.getElementById('discipline').value,
        cut1: document.getElementById('cut1Heat').value,
        cut2: document.getElementById('cut2Heat').value
    };
    localStorage.setItem('popolo_logic_data_vR', JSON.stringify(data));
}

function loadFromLocal() {
    const saved = localStorage.getItem('popolo_logic_data_vR');
    if (saved) {
        const data = JSON.parse(saved);
        results = data.results || {};
        heats = data.heats || [];
        document.getElementById('participantList').value = data.participantList || "";
        document.getElementById('discipline').value = data.discipline || "wind";
        document.getElementById('cut1Heat').value = data.cut1 || "4";
        document.getElementById('cut2Heat').value = data.cut2 || "7";
        applyParticipantsFromInput();
    }
}

function saveToFile() {
    saveToLocal();
    const data = localStorage.getItem('popolo_logic_data_vR');
    const blob = new Blob([data], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `sailing_backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
}

function loadFromFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        localStorage.setItem('popolo_logic_data_vR', e.target.result);
        loadFromLocal();
        alert("データを読み込みました");
    };
    reader.readAsText(file);
}

function clearAllData() {
    if(confirm("【警告】すべてのデータを消去しますか？")) {
        localStorage.removeItem('popolo_logic_data_vR');
        location.reload();
    }
}

// --- 選手管理 ---
function openPartModal() {
    const current = document.getElementById('participantList').value;
    document.getElementById('partTextArea').value = current.split(',').map(s=>s.trim()).join('\n');
    document.getElementById('partModal').style.display='block';
}
function closePartModal() { document.getElementById('partModal').style.display='none'; }
function submitPartModal() {
    const lines = document.getElementById('partTextArea').value.split('\n').filter(l=>l.trim());
    document.getElementById('participantList').value = lines.join(', ');
    applyParticipantsFromInput();
    saveToLocal();
    closePartModal();
}

function applyParticipantsFromInput(){
    const text = document.getElementById('participantList').value.trim();
    if(!text) { participants=[]; updateTable(); return; }
    participants = text.split(',').map(item => {
        item = item.trim();
        const firstSpace = item.search(/\s/);
        const no = (firstSpace === -1) ? item : item.substring(0, firstSpace).trim();
        return { no: no, fullName: item };
    });
    const dns = participants.length + 1;
    participants.forEach(p => { if(!results[p.no]) results[p.no] = Array(heats.length).fill(dns); });
    document.getElementById('participantCount').textContent = `${participants.length}名 登録中`;
    updateTable();
}

// --- ヒート入力 ---
function openManualHeat(){
    const container = document.getElementById('manualHeatInputs');
    container.innerHTML = ''; 
    if(isEditMode) {
        document.getElementById('manualHeatModalTitle').textContent = `H${targetHeatIndex+1} 修正`;
        let entries = participants.map(p => ({no: p.no, r: results[p.no][targetHeatIndex]}))
                                  .filter(e => e.r <= participants.length).sort((a,b)=>a.r-b.r);
        if(entries.length > 0) entries.forEach(e => addRankInput(e.no)); else addRankInput();
    } else {
        document.getElementById('manualHeatModalTitle').textContent = `新規入力`;
        addRankInput(); 
    }
    document.getElementById('manualHeatModal').style.display = 'block';
}

function addRankInput(pNo = ""){
    const container = document.getElementById('manualHeatInputs');
    const rank = container.querySelectorAll('.rank-row').length + 1;
    const div = document.createElement('div');
    div.className = 'rank-row';
    div.innerHTML = `<span style="width:50px;">${rank}位:</span><input type="text" class="mRankInput" value="${pNo}" style="width:120px; padding:10px;" inputmode="numeric">`;
    container.appendChild(div);
    const input = div.querySelector('input');
    input.focus();
    input.addEventListener('keydown', (e) => { if(e.key==='Enter'){ e.preventDefault(); if(input.value.trim()!=="") addRankInput(); } });
}

function submitManualHeat(){
    if(document.activeElement) document.activeElement.blur();
    setTimeout(() => {
        const inputs = document.getElementsByClassName('mRankInput');
        const pts = {}; let rank = 1;
        for(let i=0; i<inputs.length; i++){
            let val = inputs[i].value.trim();
            if(val!==""){ pts[val]=rank; rank++; }
        }
        const dns = participants.length + 1;
        if(isEditMode){
            participants.forEach(p => results[p.no][targetHeatIndex] = pts[p.no] || dns);
        } else {
            heats.push("H");
            participants.forEach(p => {
                if(!results[p.no]) results[p.no] = [];
                results[p.no].push(pts[p.no] || dns);
            });
        }
        updateTable(); closeManualHeatModal(); saveToLocal();
    }, 150);
}

function closeManualHeatModal(){ document.getElementById('manualHeatModal').style.display='none'; isEditMode=false; }

// --- ヒート操作 ---
function openHeatActionModal(i) {
    targetHeatIndex = i;
    document.getElementById('heatActionTitle').textContent = `H${i+1} 操作`;
    document.getElementById('heatActionModal').style.display='block';
}
function closeHeatActionModal(){ document.getElementById('heatActionModal').style.display='none'; }
function startHeatEdit() { isEditMode=true; closeHeatActionModal(); openManualHeat(); }
function confirmDeleteHeat() {
    if(confirm(`H${targetHeatIndex+1}を削除しますか？`)) {
        heats.pop();
        for(let no in results) results[no].splice(targetHeatIndex, 1);
        updateTable(); saveToLocal();
    }
    closeHeatActionModal();
}
function moveHeat(direction) {
    let newIdx = targetHeatIndex + direction;
    if(newIdx < 0 || newIdx >= heats.length) return;
    for(let no in results) {
        let tmp = results[no][targetHeatIndex];
        results[no][targetHeatIndex] = results[no][newIdx];
        results[no][newIdx] = tmp;
    }
    targetHeatIndex = newIdx;
    updateTable(); saveToLocal();
    document.getElementById('heatActionTitle').textContent = `H${targetHeatIndex+1} 操作`;
}

// --- 計算・表示 ---
function updateTable(){
    const discipline = document.getElementById('discipline').value;
    const c1 = parseInt(document.getElementById('cut1Heat').value) || 99;
    const c2 = parseInt(document.getElementById('cut2Heat').value) || 99;
    const dns = participants.length + 1;

    let scoringData = participants.map(p => {
        let pts = (results[p.no] || []).map(v => (v > participants.length ? dns : v));
        let sorted = [...pts].sort((a,b)=>b-a);
        let cutCount = (pts.length >= c2) ? 2 : (pts.length >= c1 ? 1 : 0);
        let cutVals = sorted.slice(0, cutCount);
        let total = pts.reduce((a,b)=>a+b, 0);
        let net = total - cutVals.reduce((a,b)=>a+b, 0);
        return { no: p.no, name: p.fullName, pts, total, net, cutVals: [...cutVals] };
    });

    scoringData.sort((a,b) => {
        if(a.net !== b.net) return a.net - b.net;
        if(discipline==='wind'){
            let ac = [...a.cutVals].sort((x,y)=>y-x), bc = [...b.cutVals].sort((x,y)=>y-x);
            for(let i=0; i<ac.length; i++) if(ac[i]!==bc[i]) return ac[i]-bc[i];
            let ap = [...a.pts].sort((x,y)=>x-y), bp = [...b.pts].sort((x,y)=>x-y);
            for(let i=0; i<ap.length; i++) if(ap[i]!==bp[i]) return ap[i]-bp[i];
        } else {
            if(a.total !== b.total) return a.total - b.total;
        }
        for(let i=a.pts.length-1; i>=0; i--) if(a.pts[i]!==b.pts[i]) return a.pts[i]-b.pts[i];
        return 0;
    });

    let html = `<table><tr><th>順位</th><th>No.</th><th>Name</th>`;
    heats.forEach((_, i) => html += `<th onclick="openHeatActionModal(${i})">H${i+1}</th>`);
    html += `<th>total</th><th>cut1</th><th>cut2</th><th>Net</th></tr>`;

    scoringData.forEach((r, idx) => {
        html += `<tr><td>${idx+1}</td><td>${r.no}</td><td style="text-align:left; font-size:0.8em;">${r.name}</td>`;
        let curCuts = [...r.cutVals];
        r.pts.forEach(pt => {
            let ci = curCuts.indexOf(pt);
            if(ci > -1) { curCuts.splice(ci,1); html += `<td class="cut">${pt}</td>`; }
            else html += `<td class="${pt>=dns?'dns':''}">${pt}</td>`;
        });
        html += `<td>${r.total}</td><td class="cut">${r.cutVals[0]||''}</td><td class="cut">${r.cutVals[1]||''}</td>`;
        html += `<td style="font-weight:bold; background:#fff9c4;">${r.net}</td></tr>`;
    });
    document.getElementById('tableContainer').innerHTML = `<div class="table-wrapper">${html}</table></div>`;
}

window.onload = loadFromLocal;
</script>
</body>
</html>