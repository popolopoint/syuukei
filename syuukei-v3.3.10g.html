<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>集計ちゃん v3.3.10g</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  .table-wrapper { overflow-x: auto; }
  table { 
      border-collapse: collapse; 
      table-layout: fixed;
      width: max-content;
  }
  th, td { 
      border: 1px solid #999; 
      padding: 5px 10px; 
      text-align: center; 
      white-space: nowrap; 
      width: 80px; 
  }
  th { background-color: #eee; cursor: pointer; }
  .dns { color: red; font-weight: bold; }
  .cut { color: blue; font-weight: bold; }

  /* 通常のボタンのスタイル（手入力、出力、再計算ボタン用） */
  button {
      font-size: 1.2em;
      padding: 14px 24px;
      margin: 5px 5px;
      min-width: 140px;
      cursor: pointer;
      border-radius: 6px;
      border: 1px solid #666;
      background-color: #f0f0f0;
  }
  button:active { background-color: #ddd; }

  /* ★★★ フォーム要素のサイズを拡大 ★★★ */
  select, input[type="text"], input[type="number"] {
      font-size: 1.2em; /* 拡大 */
      padding: 12px; /* 拡大 */
      min-width: 180px; /* 拡大 */
      margin: 5px 5px;
      border-radius: 5px;
      border: 1px solid #999;
      box-sizing: border-box;
  }
  textarea {
      font-size: 1.2em; /* 拡大 */
      padding: 12px; /* 拡大 */
      width: 100%;
      max-width: 600px; /* 拡大 */
      margin: 5px 0;
      border-radius: 5px;
      border: 1px solid #999;
      box-sizing: border-box;
  }

  /* ファイル選択のテキスト要素のスタイル */
  .csv-link {
      color: blue;
      text-decoration: underline;
      cursor: pointer;
      display: inline-block; 
      margin: 5px 0;
      padding: 5px;
      font-size: 1.2em; /* 拡大 */
  }
  .csv-link:hover {
      background-color: #f0f8ff; 
  }

  /* ファイル選択フィールドは非表示のまま維持 */
  input[type="file"] { display: none; }

  /* ボタン色 */
  #addManualHeatBtn { background-color: #4CAF50; color: white; } 
  #downloadCSVBtn { background-color: #2196F3; color: white; } 
  #recalcBtn { background-color: #FF9800; color: white; }      
</style>
</head>
<body>

<h2>集計ちゃん  <span style="font-size:0.7em;">by Popolo v3.3.10g</span></h2>

<label>種目: 
  <select id="discipline">
    <option value="yacht">ヨット／ウイングフォイル</option>
    <option value="wind">ウインドサーフィン</option>
  </select>
</label>
<br><br>

<label>カット設定（ヒート数を入力）:</label><br>
1カットヒート: <input type="number" id="cut1Heat" placeholder="例: 4" style="width:80px; text-align:center;">
2カットヒート: <input type="number" id="cut2Heat" placeholder="例: 8" style="width:80px; text-align:center;">
<br><br>

<label>参加選手番号（カンマ区切り）:</label>
<input type="text" id="participantList" placeholder="001,002,003,004">
<span id="participantCount" style="margin-left:10px;">0名</span>
<br>


<span id="loadParticipantText" class="csv-link">参加選手リストの読取</span>
<input type="file" id="participantCSV" accept=".csv">

<br><br>
<hr>

<h3>ヒート結果の追加</h3>

<span id="handleCSVText" class="csv-link" onclick="handleCSV()">ヒート結果CSV読取＆追加</span>
<input type="file" id="csvFile" accept=".csv">
<br>

<div id="manualInputArea">
    <label>手入力（上位から選手番号/DNS/DNF等をカンマ区切りで入力）:</label><br>
    <textarea id="manualHeatInput" rows="3" placeholder="例: 005,001,003,DNS,002"></textarea>
    <button id="addManualHeatBtn" onclick="handleManualInput()">手入力ヒートを追加</button>
</div>

<hr>
<br>

<button id="downloadCSVBtn" onclick="downloadCSV()">総合結果をCSV出力</button>
<button id="recalcBtn" onclick="updateTable()">再計算</button>

<div id="tableContainer"></div>

<script>
let results = {};
let heats = [];
let cutSettings = {};
let participants = [];
let seriesCount = 0;
let displayOrder = []; 
let currentSortAsc = true;

// --- 参加者CSV読取 (テキストクリックイベントに変更) ---
document.getElementById('loadParticipantText').addEventListener('click', () => {
    // テキストをクリックすると、裏で隠れているファイル選択フィールドが起動する
    document.getElementById('participantCSV').click();
});
document.getElementById('participantCSV').addEventListener('change', () => {
    const fileInput = document.getElementById('participantCSV');
    if(!fileInput.files.length){ 
        alert('CSVを選択してください'); 
        return; 
    }

    const reader = new FileReader();
    reader.onload = function(e){
        const lines = e.target.result.trim().split(/\r?\n/);
        if(lines.length < 2){ alert('CSVの内容が不十分です'); return; }
        const participantsArr = [];
        for(let i=1; i<lines.length; i++){ 
            const cols = lines[i].split(',');
            if(cols.length < 1) continue;
            const number = cols[0].trim();
            if(number) participantsArr.push(number);
        }
        document.getElementById('participantList').value = participantsArr.join(',');
        document.getElementById('participantCount').textContent = `${participantsArr.length}名`;
    };
    reader.readAsText(fileInput.files[0], 'utf-8');
    // ファイル選択状態をリセット
    fileInput.value = '';
});


// --- CSVヒート読取＆追加処理 (テキストクリックから呼ばれる) ---
function handleCSV(){
    const fileInput = document.getElementById('csvFile');
    
    // ファイルが選択されていない場合は、選択ダイアログを表示
    if(fileInput.files.length === 0) {
        fileInput.click();
        return; 
    }

    // テキストボックスから最新の参加者リストを取得
    const participantText = document.getElementById('participantList').value.trim();
    if(!participantText){ alert('参加選手番号を入力してください'); return; }

    const updatedParticipants = participantText.split(',').map(s=>s.trim());
    seriesCount = updatedParticipants.length;

    updatedParticipants.forEach(name=>{
        if(!results[name]){
            results[name] = Array(heats.length).fill(seriesCount + 1);
        }
    });

    participants = updatedParticipants.slice();
    displayOrder = participants.slice();

    // CSV読み込み処理
    const reader = new FileReader();
    reader.onload = function(e){
        parseCSV(e.target.result);
        updateTable();
    };
    reader.readAsText(fileInput.files[0], 'utf-8');
    
    // 処理後、ファイル選択の状態をリセット
    fileInput.value = '';
}

// ファイルが選択されたら自動的にhandleCSVを実行
document.getElementById('csvFile').addEventListener('change', () => {
    if(document.getElementById('csvFile').files.length > 0) {
        handleCSV();
    }
});


// --- CSV解析 (変更なし) ---
function parseCSV(text){
    const lines = text.trim().split(/\r?\n/);
    if(lines.length < 2) return;
    let heatName = "Heat" + (heats.length + 1);
    heats.push(heatName);
    let heatPoints = {};
    for(let i=1;i<lines.length;i++){
        const cols = lines[i].split(',');
        if(cols.length < 3) continue;
        const rankStr = cols[1].trim();
        const colorNumber = cols[2].trim();
        if(!participants.includes(colorNumber)) continue;
        let rank = parseInt(rankStr,10);
        heatPoints[colorNumber] = !isNaN(rank) ? rank : seriesCount + 1;
    }
    participants.forEach(name=>{
        if(!results[name]) results[name] = Array(heats.length - 1).fill(seriesCount + 1);
        results[name].push(heatPoints[name] !== undefined ? heatPoints[name] : seriesCount + 1);
    });
}

// --- 手入力処理 (変更なし) ---
function handleManualInput(){
    const inputArea = document.getElementById('manualHeatInput');
    const manualText = inputArea.value.trim();
    
    if(!manualText){ alert('手入力欄に選手番号を入力してください'); return; }

    const participantText = document.getElementById('participantList').value.trim();
    if(!participantText){ alert('参加選手番号を入力してください'); return; }

    const updatedParticipants = participantText.split(',').map(s=>s.trim());
    seriesCount = updatedParticipants.length;

    updatedParticipants.forEach(name=>{
        if(!results[name]){
            results[name] = Array(heats.length).fill(seriesCount + 1);
        }
    });

    participants = updatedParticipants.slice();
    displayOrder = participants.slice();

    parseManualInput(manualText);
    updateTable();
    
    inputArea.value = ''; 
}

// --- 手入力解析 (変更なし) ---
function parseManualInput(text){
    const rankEntries = text.split(',').map(s=>s.trim()).filter(s=>s!==''); 
    
    if(rankEntries.length === 0) return;
    
    let heatName = "Heat" + (heats.length + 1) + "(M)";
    heats.push(heatName);
    let heatPoints = {};
    
    let rank = 1;
    for(let i=0; i < rankEntries.length; i++){
        const entry = rankEntries[i].toUpperCase();
        
        if(participants.includes(entry)){
            if(heatPoints[entry] === undefined){
                heatPoints[entry] = rank;
                rank++;
            }
        } else if(entry === 'DNS' || entry === 'DNF' || entry === 'OCS' || entry === 'DSQ' || entry === 'RET'){
            // 特殊記号は順位をカウントアップせずスキップ
        }
    }
    
    participants.forEach(name=>{
        if(!results[name]) results[name] = Array(heats.length - 1).fill(seriesCount + 1);
        results[name].push(heatPoints[name] !== undefined ? heatPoints[name] : seriesCount + 1);
    });
}


// --- ネットポイント計算用のカット数取得 (変更なし) ---
function getCutCount(heatCount){
    let count = 0;
    for(let key of Object.keys(cutSettings).sort((a,b)=>a-b)){
        if(heatCount >= key) count = cutSettings[key];
    }
    return count;
}

// --- ネットポイント計算 (変更なし) ---
function calculateNetPoints(){
    let netResults = {};
    const discipline = document.getElementById('discipline').value;
    
    for(let name of participants){
        let points = results[name].slice();
        let cutCount = getCutCount(points.length);
        
        let sortedForCut = points.map((p,i)=>({p,i})).sort((a,b)=>b.p - a.p); 
        
        let cuts = [];
        let keptPoints = [];
        let cutIndices = new Set();
        
        if(cutCount > 0){
            for(let i=0; i < cutCount; i++){
                if(sortedForCut[i]) cutIndices.add(sortedForCut[i].i);
            }
        }
        
        let totalPoints = 0;
        for(let i=0; i < points.length; i++){
            totalPoints += points[i];
            if(cutIndices.has(i)){
                cuts.push(points[i]);
                cutIndices.delete(i); 
            } else {
                keptPoints.push(points[i]);
            }
        }
        
        let netPoints = totalPoints - cuts.reduce((a,b)=>a+b,0);
        
        // タイブレーク用のデータ準備
        let cutsSorted = cuts.slice().sort((a,b)=>a-b);
        let allPointsSorted = points.slice().sort((a,b)=>a-b);

        keptPoints.sort((a,b)=>a-b);

        netResults[name] = {
            points, 
            cuts: cuts.sort((a,b)=>b-a),
            net: netPoints, 
            total: totalPoints,
            
            // --- タイブレーク用 ---
            discipline,
            keptPoints,
            cutsSorted,
            allPointsSorted
        };
    }
    return netResults;
}


// --- 表更新 (変更なし) ---
function updateTable(){
    cutSettings = {};
    const cut1 = parseInt(document.getElementById('cut1Heat').value);
    const cut2 = parseInt(document.getElementById('cut2Heat').value);
    if(!isNaN(cut1)) cutSettings[cut1] = 1;
    if(!isNaN(cut2)) cutSettings[cut2] = 2;

    const netResults = calculateNetPoints();

    let html = "<div class='table-wrapper'><table id='resultsTable'><tr>";
    html += `<th onclick="sortTableByColumn(0)">順位</th>`;
    html += `<th>選手名</th>`;
    heats.forEach((h,i)=>html += `<th onclick="deleteHeat(${i})">${h}</th>`);
    html += "<th>カット前合計</th>";
    let maxCut = Math.max(...Object.values(cutSettings),0);
    for(let i=1;i<=maxCut;i++){ html += `<th>カット${i}</th>`; }
    html += "<th>Net</th></tr>";

    displayOrder.forEach((name,index)=>{
        let r = netResults[name];
        html += `<tr><td>${index+1}</td><td>${name}</td>`;
        r.points.forEach(p=>{ html += `<td>${p === seriesCount + 1 ? "<span class='dns'>"+p+"</span>" : p}</td>`; });
        html += `<td>${r.total}</td>`;
        for(let i=0;i<maxCut;i++){ html += `<td>${r.cuts[i] !== undefined ? "<span class='cut'>"+r.cuts[i]+"</span>":""}</td>`; }
        html += `<td>${r.net}</td></tr>`;
    });

    document.getElementById('tableContainer').innerHTML = html + "</table></div>";
}

// --- ヒート削除 (変更なし) ---
function deleteHeat(index){
    if(!confirm(`"${heats[index]}" を削除しますか？`)) return;
    heats.splice(index,1);
    participants.forEach(name=>{
        if(results[name] && results[name].length>index) results[name].splice(index,1);
    });
    updateTable();
}

// --- 順位ソート（Net値基準） (変更なし) ---
function sortTableByColumn(colIndex){
    if(colIndex !== 0) return;
    const netResults = calculateNetPoints();
    const discipline = document.getElementById('discipline').value;
    
    displayOrder.sort((a,b)=>{
        let rA = netResults[a];
        let rB = netResults[b];
        
        let netDiff = rA.net - rB.net;
        if(netDiff !== 0) return currentSortAsc ? netDiff : -netDiff;

        let tieBreakResult = 0;
        
        if(discipline === 'yacht'){
            tieBreakResult = compareArrays(rA.keptPoints, rB.keptPoints);
            if(tieBreakResult !== 0) return currentSortAsc ? tieBreakResult : -tieBreakResult;
            
            let pointsA = rA.points.slice();
            let pointsB = rB.points.slice();
            tieBreakResult = compareArrays(pointsA.reverse(), pointsB.reverse()); 
            if(tieBreakResult !== 0) return currentSortAsc ? tieBreakResult : -tieBreakResult;

        } else if(discipline === 'wind'){
            
            tieBreakResult = compareArrays(rA.cutsSorted, rB.cutsSorted);
            if(tieBreakResult !== 0) return currentSortAsc ? tieBreakResult : -tieBreakResult;
            
            tieBreakResult = compareArrays(rA.allPointsSorted, rB.allPointsSorted);
            if(tieBreakResult !== 0) return currentSortAsc ? tieBreakResult : -tieBreakResult;
            
            let pointsA = rA.points.slice();
            let pointsB = rB.points.slice();
            tieBreakResult = compareArrays(pointsA.reverse(), pointsB.reverse());
            if(tieBreakResult !== 0) return currentSortAsc ? tieBreakResult : -tieBreakResult;

        }

        return currentSortAsc ? a.localeCompare(b) : b.localeCompare(a);
    });

    updateTable();
    currentSortAsc = !currentSortAsc;
}

// 配列同士を要素ごとに比較し、最初の差分を返すヘルパー関数 (変更なし)
function compareArrays(arrA, arrB){
    const len = Math.max(arrA.length, arrB.length);
    for(let i=0; i < len; i++){
        const valA = arrA[i] !== undefined ? arrA[i] : Infinity;
        const valB = arrB[i] !== undefined ? arrB[i] : Infinity;

        if(valA !== valB) return valA - valB;
    }
    return 0;
}


// --- CSV出力 (変更なし) ---
function downloadCSV(){
    const netResults = calculateNetPoints();
    let csv = "順位,選手名,カット前合計," + heats.join(",") + ",カット,Net\n";
    displayOrder.forEach((name,index)=>{
        let r = netResults[name];
        csv += `${index+1},${name},${r.total},${r.points.join(",")},(${r.cuts.join(',')}),${r.net}\n`;
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "総合結果_v3.3.9g.csv";
    a.click();
    URL.revokeObjectURL(url);
}
</script>
</body>
</html>