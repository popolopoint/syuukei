<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>集計ちゃん v3.7.2d</title>
<style>
  body { font-size: 20px; font-family: sans-serif; padding: 15px; line-height: 1.4; background-color: #f9f9f9; color: #333; }
  .table-wrapper { overflow-x: auto; margin-top: 20px; background: white; border: 1px solid #999; }
  table { border-collapse: collapse; width: max-content; font-size: 22px; }
  th, td { border: 1px solid #999; padding: 12px 10px; text-align: center; white-space: nowrap; }
  th { background-color: #eee; }
  .save-panel { background:#e3f2fd; padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid #2196F3; display: flex; gap: 5px; }
  button { font-size: 18px; padding: 15px; margin: 5px 2px; cursor: pointer; border-radius: 10px; border: 1px solid #666; background-color: #f0f0f0; font-weight: bold; touch-action: manipulation; }
  .calc-btn { background:#FF9800 !important; color:white !important; border:none !important; width:100%; margin-bottom: 10px; }
  .csv-btn { background:#2E7D32 !important; color:white !important; border:none !important; flex: 1; font-size: 16px; }
  .copy-btn { background:#00B900 !important; color:white !important; border:none !important; flex: 1; font-size: 16px; }
  .cut { color: blue; font-weight: bold; opacity: 0.6; }
  .dns { color: red; font-weight: bold; }
  .modal { display:none; position:fixed; top:5%; left:50%; transform:translateX(-50%); border:2px solid #666; padding:20px; background:#fff; z-index: 2000; width: 85%; max-height: 85vh; overflow-y: auto; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  textarea { width: 100%; height: 200px; font-size: 18px; padding: 10px; box-sizing: border-box; }
  .rank-row { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
  .mRankInput { font-size: 20px; padding: 12px; width: 70%; border: 1px solid #ccc; border-radius: 5px; }
</style>
</head>
<body>

<h3>集計ちゃん <span style="font-size:0.7em;">v3.7.2d</span></h3>

<div class="save-panel">
  <button onclick="saveToFile()" style="flex:1;">保存</button>
  <button onclick="document.getElementById('fileInput').click()" style="flex:1;">読込</button>
  <button onclick="clearAllData()" style="background:#f44336; color:white; flex:0.5;">消去</button>
  <input type="file" id="fileInput" style="display:none" onchange="loadFromFile(event)">
</div>

<div style="background:#eee; padding:15px; border-radius:8px;">
  <select id="discipline" onchange="forceRecalc();" style="width:100%; padding:12px; font-size:20px; font-weight:bold;">
    <option value="yacht">ウイング / ヨット（付則A）</option>
    <option value="wind">ウインドサーフィン（付則B）</option>
  </select>
  <div style="margin-top:10px;">
    1枚目:<input type="number" id="cut1Heat" value="4" style="font-size:20px; width:50px;"> 
    2枚目:<input type="number" id="cut2Heat" value="7" style="font-size:20px; width:50px;">
    <button onclick="openModal('tieBreakModal')" style="padding:5px 10px; font-size:14px;">タイ解説</button>
  </div>
</div>

<div style="margin-top:15px;">
  <button onclick="openPartModal()" style="background:#f44336; color:white; width:100%;">選手名を一括入力</button>
  <input type="text" id="participantList" placeholder="例: J1, J2, J3" style="width: 100%; padding:12px; font-size:18px; margin-top:5px; box-sizing:border-box;">
  <button onclick="forceRecalc()" class="calc-btn">【 1 】 表を計算・更新</button>
  <div style="display: flex; gap:10px;">
    <button onclick="exportCSV()" class="csv-btn">【 2 】 CSV送信</button>
    <button onclick="copyForLine()" class="copy-btn">【 2 】 LINEコピー</button>
  </div>
</div>

<hr>
<button onclick="openManualHeat()" style="background-color: #9C27B0; color:white; width:100%; padding: 20px;">＋ 着順を手入力</button>

<div id="tableContainer"></div>

<div id="partModal" class="modal">
    <h3>選手名入力</h3>
    <textarea id="partTextArea" placeholder="J1&#10;J2&#10;J3"></textarea>
    <button onclick="submitPartModal()" style="width:100%; background:#4CAF50; color:white; padding:15px;">反映</button>
    <button onclick="closeModal('partModal')" style="width:100%; margin-top:10px;">閉じる</button>
</div>

<div id="manualHeatModal" class="modal">
    <h3>着順入力</h3>
    <div id="manualHeatInputs"></div>
    <button onclick="addRankInput()" style="width:100%; background:#eee; border:1px dashed #999; padding:15px;">+ 次の順位を追加</button>
    <button onclick="submitManualHeat()" style="width:100%; background:#4CAF50; color:white; margin-top:15px; padding:15px;">このヒートを保存</button>
    <button onclick="closeModal('manualHeatModal')" style="width:100%; margin-top:10px;">キャンセル</button>
</div>

<div id="tieBreakModal" class="modal">
  <h3>タイ解説</h3>
  <div id="tieText" style="font-size:18px;"></div>
  <button onclick="closeModal('tieBreakModal')" style="width:100%;">閉じる</button>
</div>
<div id="heatActionModal" class="modal">
    <h3 id="heatActionTitle">操作</h3>
    <button onclick="moveHeat(-1)" style="width:45%;">←移動</button>
    <button onclick="moveHeat(1)" style="width:45%;">移動→</button><hr>
    <button style="width:100%; background:#4CAF50; color:white;" onclick="startHeatEdit()">修正</button>
    <button style="width:100%; background:#f44336; color:white; margin-top:10px;" onclick="confirmDeleteHeat()">削除</button>
    <button style="width:100%; margin-top:15px;" onclick="closeModal('heatActionModal')">閉じる</button>
</div>

<script>
let results = {}; let participants = []; let heats = []; 
let targetHeatIndex = -1; let isEditMode = false; let lastScoredData = [];

function openModal(id) { 
  if(id==='tieBreakModal'){
    const d = document.getElementById('discipline').value;
    document.getElementById('tieText').innerHTML = d==='yacht' ? "ヨット付則A: 1.Net 2.良いスコア順 3.最新ヒート順" : "ウインド付則B: 1.Net 2.除外点比較 3.全スコア比較 4.最新ヒート順";
  }
  document.getElementById(id).style.display = 'block'; 
}
function closeModal(id) { document.getElementById(id).style.display = 'none'; }

function forceRecalc() { applyParticipantsFromInput(); updateTable(); saveToLocal(); }
function saveToLocal() { const data = { results, heats, participantList: document.getElementById('participantList').value, discipline: document.getElementById('discipline').value, cut1: document.getElementById('cut1Heat').value, cut2: document.getElementById('cut2Heat').value }; localStorage.setItem('sailing_v372d', JSON.stringify(data)); }
function loadFromLocal() { const saved = localStorage.getItem('sailing_v372d'); if (saved) { const data = JSON.parse(saved); Object.assign(this, data); results = data.results||{}; heats = data.heats||[]; forceRecalc(); } }

function applyParticipantsFromInput(){
    const text = document.getElementById('participantList').value.trim();
    if(!text) { participants=[]; return; }
    participants = text.split(',').map(item => { item = item.trim(); const firstSpace = item.search(/\s/); const no = (firstSpace === -1) ? item : item.substring(0, firstSpace).trim(); return { no: no, fullName: item }; });
    const dns = participants.length + 1;
    participants.forEach(p => { if(!results[p.no]) results[p.no] = Array(heats.length).fill(dns); });
}

function openPartModal() { 
    document.getElementById('partTextArea').value = document.getElementById('participantList').value.split(',').map(s=>s.trim()).join('\n');
    openModal('partModal'); 
}
function submitPartModal() { 
    document.getElementById('participantList').value = document.getElementById('partTextArea').value.split('\n').filter(l=>l.trim()).join(', '); 
    forceRecalc(); closeModal('partModal'); 
}

// --- 着順入力（iPhone改行対応） ---
function openManualHeat(){
    const container = document.getElementById('manualHeatInputs'); container.innerHTML = ''; 
    if(isEditMode) {
        let entries = participants.map(p => ({no: p.no, r: results[p.no][targetHeatIndex]})).filter(e => e.r <= participants.length).sort((a,b)=>a.r-b.r);
        if(entries.length > 0) entries.forEach(e => addRankInput(e.no)); else addRankInput();
    } else { addRankInput(); }
    openModal('manualHeatModal');
}

function addRankInput(pNo = ""){
    const container = document.getElementById('manualHeatInputs');
    const rank = container.querySelectorAll('.rank-row').length + 1;
    const div = document.createElement('div');
    div.className = 'rank-row';
    // iPhoneで「次へ」や「改行」を押したときに発火させるイベントを追加
    div.innerHTML = `<span>${rank}位:</span><input type="text" class="mRankInput" value="${pNo}" enterkeyhint="next" inputmode="text">`;
    container.appendChild(div);
    
    const input = div.querySelector('input');
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault(); // 改行を防ぐ
            if (this.value.trim() !== "") {
                addRankInput(); // 新しい窓を開く
            }
        }
    });
    input.focus();
}

function submitManualHeat(){
    const inputs = document.getElementsByClassName('mRankInput');
    const pts = {}; let rank = 1;
    for(let i=0; i<inputs.length; i++){
        let val = inputs[i].value.trim().toUpperCase();
        if(val!==""){ 
          const realP = participants.find(p => p.no.toUpperCase() === val); 
          if(realP) { pts[realP.no] = rank; rank++; } 
        }
    }
    const dns = participants.length + 1;
    if(isEditMode){ participants.forEach(p => results[p.no][targetHeatIndex] = pts[p.no] || dns); }
    else { heats.push("H"); participants.forEach(p => { if(!results[p.no]) results[p.no] = []; results[p.no].push(pts[p.no] || dns); }); }
    closeModal('manualHeatModal'); isEditMode = false; forceRecalc();
}

function openHeatActionModal(i) { targetHeatIndex = i; openModal('heatActionModal'); }
function startHeatEdit() { isEditMode=true; closeModal('heatActionModal'); openManualHeat(); }
function confirmDeleteHeat() { if(confirm(`H${targetHeatIndex+1}を削除？`)) { heats.splice(targetHeatIndex, 1); for(let no in results) results[no].splice(targetHeatIndex, 1); forceRecalc(); } closeModal('heatActionModal'); }
function moveHeat(direction) {
    let n = targetHeatIndex + direction; if(n<0||n>=heats.length) return;
    for(let k in results){ let t=results[k][targetHeatIndex]; results[k][targetHeatIndex]=results[k][n]; results[k][n]=t; }
    forceRecalc(); closeModal('heatActionModal');
}

function updateTable(){
    const disc = document.getElementById('discipline').value;
    const c1 = parseInt(document.getElementById('cut1Heat').value)||99, c2 = parseInt(document.getElementById('cut2Heat').value)||99;
    const dns = participants.length + 1;
    let sd = participants.map(p => {
        let pts = (results[p.no] || []).map(v => (v > participants.length ? dns : v));
        let sfc = pts.map((val, idx) => ({val, idx})).sort((a,b) => b.val - a.val);
        let cc = (pts.length >= c2) ? 2 : (pts.length >= c1 ? 1 : 0);
        let ci = sfc.slice(0, cc).map(x => x.idx);
        let net = 0, ncp = [], cp = [];
        pts.forEach((pt, i) => { if(ci.includes(i)) cp.push(pt); else { net += pt; ncp.push(pt); } });
        return { no: p.no, name: p.fullName, pts, net, cp, ncp, total: pts.reduce((a,b)=>a+b,0) };
    });
    sd.sort((a,b) => {
        if(a.net !== b.net) return a.net - b.net;
        if(disc==='yacht'){
            let aS = [...a.ncp].sort((x,y)=>x-y), bS = [...b.ncp].sort((x,y)=>x-y);
            for(let i=0; i<aS.length; i++) if(aS[i] !== bS[i]) return aS[i] - bS[i];
        } else {
            let acS = [...a.cp].sort((x,y)=>x-y), bcS = [...b.cp].sort((x,y)=>x-y);
            for(let i=0; i<acS.length; i++) if(acS[i] !== bcS[i]) return acS[i] - bcS[i];
            let apS = [...a.pts].sort((x,y)=>x-y), bpS = [...b.pts].sort((x,y)=>x-y);
            for(let i=0; i<apS.length; i++) if(apS[i] !== bpS[i]) return apS[i] - bpS[i];
        }
        for(let i=a.pts.length-1; i>=0; i--) if(a.pts[i] !== b.pts[i]) return a.pts[i] - b.pts[i];
        return 0;
    });
    lastScoredData = sd;
    let html = `<table><tr><th>順位</th><th>No.</th><th>Name</th>` + heats.map((_,i)=>`<th onclick="openHeatActionModal(${i})">H${i+1}</th>`).join("") + `<th>Net</th></tr>`;
    sd.forEach((r, idx) => {
        html += `<tr><td>${idx+1}</td><td>${r.no}</td><td style="text-align:left;">${r.name}</td>`;
        let sfc = r.pts.map((v, i) => ({v, i})).sort((a,b) => b.v - a.v);
        let cc = (r.pts.length >= c2) ? 2 : (r.pts.length >= c1 ? 1 : 0);
        let ci = sfc.slice(0, cc).map(x => x.i);
        r.pts.forEach((pt, i) => html += `<td class="${ci.includes(i)?'cut':''} ${pt>=dns?'dns':''}">${pt}</td>`);
        html += `<td style="font-weight:bold; background:#fff9c4;">${r.net}</td></tr>`;
    });
    document.getElementById('tableContainer').innerHTML = `<div class="table-wrapper">${html}</table></div>`;
}

function exportCSV() {
    let csv = "\uFEFFRank,No.,Name," + heats.map((_,i)=>`H${i+1}`).join(",") + ",Total,Net\n";
    lastScoredData.forEach((r, idx) => { csv += `${idx+1},${r.no},"${r.name}",${r.pts.join(",")},${r.total},${r.net}\n`; });
    const b = new Blob([csv], { type: 'text/csv' });
    if (navigator.share) navigator.share({ files: [new File([b], "result.csv", { type: 'text/csv' })] });
}
function copyForLine() {
    let t = `【速報】\n`;
    lastScoredData.forEach((r, idx) => { t += `${idx+1}位 ${r.no} ${r.name} (${r.net})\n`; });
    navigator.clipboard.writeText(t).then(() => alert("コピー完了"));
}
window.onload = loadFromLocal;
</script>
</body>
</html>