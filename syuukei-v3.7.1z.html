<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>集計ちゃん v3.7.1Z</title>
<style>
  body { font-family: sans-serif; padding: 15px; line-height: 1.4; background-color: #f9f9f9; color: #333; }
  .table-wrapper { overflow-x: auto; margin-top: 20px; background: white; border: 1px solid #999; -webkit-overflow-scrolling: touch; }
  table { border-collapse: collapse; table-layout: fixed; width: max-content; }
  th, td { border: 1px solid #999; padding: 10px 8px; text-align: center; white-space: nowrap; width: 90px; }
  th { background-color: #eee; position: sticky; top: 0; z-index: 10; cursor: pointer; }
  .dns { color: red; font-weight: bold; }
  .cut { color: blue; font-weight: bold; opacity: 0.7; }
  .save-panel { background:#e3f2fd; padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid #2196F3; }
  button { font-size: 1.0em; padding: 12px 15px; margin: 5px 2px; min-width: 100px; cursor: pointer; border-radius: 8px; border: 1px solid #666; background-color: #f0f0f0; touch-action: manipulation; }
  .modal { display:none; position:fixed; top:5%; left:50%; transform:translateX(-50%); border:1px solid #999; padding:20px; background:#fff; z-index: 2000; width: 85%; max-width: 400px; max-height: 85vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.4); border-radius: 12px; }
  .rank-row { margin-bottom: 10px; display: flex; align-items: center; }
  textarea { width: 100%; height: 150px; font-size: 16px; margin-bottom: 10px; }
  .calc-btn { background:#FF9800 !important; color:white !important; border:none !important; font-weight:bold; width:100%; max-width:300px; }
  .tie-btn { background:#607D8B !important; color:white !important; border:none !important; min-width: auto !important; padding: 5px 10px !important; font-size: 0.8em !important; }
</style>
</head>
<body>

<h3>集計ちゃん <span style="font-size:0.7em;">v3.7.1Z</span></h3>

<div class="save-panel">
  <button onclick="saveToFile()" style="background:#2196F3; color:white;">ファイル保存</button>
  <button onclick="document.getElementById('fileInput').click()" style="background:#4CAF50; color:white;">読込</button>
  <button onclick="clearAllData()" style="background:#f44336; color:white; min-width:60px;">消去</button>
  <input type="file" id="fileInput" style="display:none" onchange="loadFromFile(event)">
</div>

<div style="background:#eee; padding:10px; border-radius:8px;">
  <strong>種目:</strong> 
  <button onclick="document.getElementById('tieBreakModal').style.display='block'" class="tie-btn">タイの解き方を確認</button><br>
  <select id="discipline" onchange="forceRecalc();" style="width:100%; padding:10px; font-size:1em; margin:5px 0;">
    <option value="yacht">ウイング / ヨット（付則A）</option>
    <option value="wind">ウインドサーフィン（付則B）</option>
  </select>
  <div>
    カット: 1枚:<input type="number" id="cut1Heat" value="4" style="width:35px;" onchange="forceRecalc();"> 
    2枚:<input type="number" id="cut2Heat" value="7" style="width:35px;" onchange="forceRecalc();">
  </div>
</div>

<div style="margin-top:10px;">
  <button onclick="openPartModal()" style="background:#f44336; color:white; width:100%; max-width:300px;">選手入力（一括）</button>
  <input type="text" id="participantList" placeholder="J1 Taro, J2 Hanako" style="width: 100%; margin-top:5px;">
  <div id="participantCount" style="font-weight:bold; margin:5px 0; color:#2196F3;">0名</div>
  <button onclick="forceRecalc()" class="calc-btn">表を更新・再計算</button>
</div>

<hr>
<button onclick="openManualHeat()" style="background-color: #9C27B0; color:white; width:100%; max-width:300px;">着順を手入力</button>

<div id="tableContainer"></div>

<div id="tieBreakModal" class="modal">
    <h3>タイブレークの優先順位</h3>
    <p><strong>【ウイング/ヨット（付則A）】</strong><br>
    1. Net（除外後）合計<br>
    2. 除外分をのぞくスコアを<b>「良い順」</b>に比較<br>
    3. 除外分を含む<b>「最新のヒート」</b>から遡って比較</p>
    <hr>
    <p><strong>【ウインド（付則B）】</strong><br>
    1. Net（除外後）合計<br>
    2. <b>「除外された点数」</b>が良い方が上位<br>
    3. 除外分を含む全スコアを<b>「良い順」</b>に比較<br>
    4. 除外分を含む<b>「最新のヒート」</b>から遡って比較</p>
    <button onclick="this.parentElement.style.display='none'" style="width:100%; padding:10px;">閉じる</button>
</div>

<div id="manualHeatModal" class="modal">
    <h3>着順入力</h3>
    <div id="manualHeatInputs"></div>
    <button onclick="addRankInput()" style="width:100%; background:#eee; border:1px dashed #999;">+ 追加</button>
    <button onclick="submitManualHeat()" style="width:100%; background:#4CAF50; color:white; margin-top:15px; padding:15px;">確定保存</button>
    <button style="width:100%; margin-top:10px;" onclick="closeManualHeatModal()">キャンセル</button>
</div>

<div id="partModal" class="modal">
    <h3>選手入力</h3>
    <textarea id="partTextArea"></textarea>
    <button onclick="submitPartModal()" style="width:100%; background:#4CAF50; color:white; padding:15px;">反映</button>
    <button style="width:100%; margin-top:10px;" onclick="closePartModal()">閉じる</button>
</div>

<div id="heatActionModal" class="modal">
    <h3 id="heatActionTitle">操作</h3>
    <button onclick="moveHeat(-1)" style="background:#2196F3; color:white;">← 左移動</button>
    <button onclick="moveHeat(1)" style="background:#2196F3; color:white;">右移動 →</button>
    <hr>
    <button style="width:100%; background:#4CAF50; color:white;" onclick="startHeatEdit()">修正</button>
    <button style="width:100%; background:#f44336; color:white; margin-top:10px;" onclick="confirmDeleteHeat()">削除</button>
    <button style="width:100%; margin-top:15px;" onclick="closeHeatActionModal()">閉じる</button>
</div>

<script>
let results = {}; let participants = []; let heats = []; 
let targetHeatIndex = -1; let isEditMode = false;

function forceRecalc() { applyParticipantsFromInput(); updateTable(); saveToLocal(); }
function saveToLocal() { const data = { results, heats, participantList: document.getElementById('participantList').value, discipline: document.getElementById('discipline').value, cut1: document.getElementById('cut1Heat').value, cut2: document.getElementById('cut2Heat').value }; localStorage.setItem('sailing_data_vZ', JSON.stringify(data)); }
function loadFromLocal() { const saved = localStorage.getItem('sailing_data_vZ'); if (saved) { const data = JSON.parse(saved); results = data.results || {}; heats = data.heats || []; document.getElementById('participantList').value = data.participantList || ""; document.getElementById('discipline').value = data.discipline || "yacht"; document.getElementById('cut1Heat').value = data.cut1 || "4"; document.getElementById('cut2Heat').value = data.cut2 || "7"; forceRecalc(); } }
function saveToFile() { saveToLocal(); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([localStorage.getItem('sailing_data_vZ')], {type: 'application/json'})); a.download = `sailing_result.json`; a.click(); }
function loadFromFile(event) { const reader = new FileReader(); reader.onload = (e) => { localStorage.setItem('sailing_data_vZ', e.target.result); loadFromLocal(); }; reader.readAsText(event.target.files[0]); }
function clearAllData() { if(confirm("消去？")) { localStorage.removeItem('sailing_data_vZ'); location.reload(); } }

function applyParticipantsFromInput(){
    const text = document.getElementById('participantList').value.trim();
    if(!text) { participants=[]; return; }
    participants = text.split(',').map(item => { item = item.trim(); const firstSpace = item.search(/\s/); const no = (firstSpace === -1) ? item : item.substring(0, firstSpace).trim(); return { no: no, fullName: item }; });
    const dns = participants.length + 1;
    participants.forEach(p => { if(!results[p.no]) results[p.no] = Array(heats.length).fill(dns); });
    document.getElementById('participantCount').textContent = `${participants.length}名`;
}

function openPartModal() { document.getElementById('partTextArea').value = document.getElementById('participantList').value.split(',').map(s=>s.trim()).join('\n'); document.getElementById('partModal').style.display='block'; }
function closePartModal() { document.getElementById('partModal').style.display='none'; }
function submitPartModal() { document.getElementById('participantList').value = document.getElementById('partTextArea').value.split('\n').filter(l=>l.trim()).join(', '); forceRecalc(); closePartModal(); }

function openManualHeat(){
    const container = document.getElementById('manualHeatInputs'); container.innerHTML = ''; 
    if(isEditMode) {
        let entries = participants.map(p => ({no: p.no, r: results[p.no][targetHeatIndex]})).filter(e => e.r <= participants.length).sort((a,b)=>a.r-b.r);
        if(entries.length > 0) entries.forEach(e => addRankInput(e.no)); else addRankInput();
    } else { addRankInput(); }
    document.getElementById('manualHeatModal').style.display = 'block';
}
function addRankInput(pNo = ""){
    const container = document.getElementById('manualHeatInputs');
    const rank = container.querySelectorAll('.rank-row').length + 1;
    const div = document.createElement('div');
    div.className = 'rank-row';
    div.innerHTML = `<span style="width:50px;">${rank}位:</span><input type="text" class="mRankInput" value="${pNo}" style="width:120px; padding:10px;">`;
    container.appendChild(div);
    const input = div.querySelector('input');
    input.addEventListener('keydown', (e) => { if(e.key==='Enter'){ e.preventDefault(); if(input.value.trim()!=="") addRankInput(); } });
    input.focus();
}
function submitManualHeat(){
    if(document.activeElement) document.activeElement.blur();
    setTimeout(() => {
        const inputs = document.getElementsByClassName('mRankInput');
        const pts = {}; let rank = 1;
        for(let i=0; i<inputs.length; i++){
            let val = inputs[i].value.trim().toUpperCase();
            if(val!==""){ const realP = participants.find(p => p.no.toUpperCase() === val); if(realP) pts[realP.no] = rank; rank++; }
        }
        const dns = participants.length + 1;
        if(isEditMode){ participants.forEach(p => results[p.no][targetHeatIndex] = pts[p.no] || dns); }
        else { heats.push("H"); participants.forEach(p => { if(!results[p.no]) results[p.no] = []; results[p.no].push(pts[p.no] || dns); }); }
        closeManualHeatModal(); forceRecalc();
    }, 150);
}
function closeManualHeatModal(){ document.getElementById('manualHeatModal').style.display='none'; isEditMode=false; }
function openHeatActionModal(i) { targetHeatIndex = i; document.getElementById('heatActionTitle').textContent = `H${i+1} 操作`; document.getElementById('heatActionModal').style.display='block'; }
function closeHeatActionModal(){ document.getElementById('heatActionModal').style.display='none'; }
function startHeatEdit() { isEditMode=true; closeHeatActionModal(); openManualHeat(); }
function confirmDeleteHeat() { if(confirm(`H${targetHeatIndex+1}削除？`)) { heats.pop(); for(let no in results) results[no].splice(targetHeatIndex, 1); forceRecalc(); } closeHeatActionModal(); }
function moveHeat(direction) {
    let newIdx = targetHeatIndex + direction;
    if(newIdx < 0 || newIdx >= heats.length) return;
    for(let no in results) { let tmp = results[no][targetHeatIndex]; results[no][targetHeatIndex] = results[no][newIdx]; results[no][newIdx] = tmp; }
    targetHeatIndex = newIdx; forceRecalc(); closeHeatActionModal();
}

function updateTable(){
    const disc = document.getElementById('discipline').value;
    const c1 = parseInt(document.getElementById('cut1Heat').value) || 99;
    const c2 = parseInt(document.getElementById('cut2Heat').value) || 99;
    const dns = participants.length + 1;
    let scoringData = participants.map(p => {
        let pts = (results[p.no] || []).map(v => (v > participants.length ? dns : v));
        // カット対象を特定（大きい順に並べて上位n個をカット）
        let sortedForCut = pts.map((val, idx) => ({val, idx})).sort((a,b) => b.val - a.val);
        let cutCount = (pts.length >= c2) ? 2 : (pts.length >= c1 ? 1 : 0);
        let cutIndices = sortedForCut.slice(0, cutCount).map(x => x.idx);
        
        let netScore = 0;
        let nonCutPts = [];
        let cutPts = [];
        pts.forEach((p, i) => {
            if(cutIndices.includes(i)) { cutPts.push(p); }
            else { netScore += p; nonCutPts.push(p); }
        });

        return { no: p.no, name: p.fullName, pts, net: netScore, cutPts, nonCutPts };
    });

    scoringData.sort((a,b) => {
        // 1. Net得点
        if(a.net !== b.net) return a.net - b.net;

        if(disc==='yacht'){
            // 【付則A】
            // A-1. 除外分を除いたスコアを「良い順」に比較
            let aSorted = [...a.nonCutPts].sort((x,y)=>x-y);
            let bSorted = [...b.nonCutPts].sort((x,y)=>x-y);
            for(let i=0; i<aSorted.length; i++){
                if(aSorted[i] !== bSorted[i]) return aSorted[i] - bSorted[i];
            }
        } else {
            // 【付則B】
            // B-1. 除外された点数を比較
            let acSorted = [...a.cutPts].sort((x,y)=>x-y);
            let bcSorted = [...b.cutPts].sort((x,y)=>x-y);
            for(let i=0; i<acSorted.length; i++){
                if(acSorted[i] !== bcSorted[i]) return acSorted[i] - bcSorted[i];
            }
            // B-2. 除外分を含む全スコアを「良い順」に比較
            let apSorted = [...a.pts].sort((x,y)=>x-y);
            let bpSorted = [...b.pts].sort((x,y)=>x-y);
            for(let i=0; i<apSorted.length; i++){
                if(apSorted[i] !== bpSorted[i]) return apSorted[i] - bpSorted[i];
            }
        }
        
        // 共通最後：最新のヒートから遡って比較（除外分含む）
        for(let i=a.pts.length-1; i>=0; i--){
            if(a.pts[i] !== b.pts[i]) return a.pts[i] - b.pts[i];
        }
        return 0;
    });

    let html = `<table><tr><th>順位</th><th>No.</th><th>Name</th>`;
    heats.forEach((_, i) => html += `<th onclick="openHeatActionModal(${i})">H${i+1}</th>`);
    html += `<th>cut1</th><th>cut2</th><th>Net</th></tr>`;
    scoringData.forEach((r, idx) => {
        html += `<tr><td>${idx+1}</td><td>${r.no}</td><td style="text-align:left; font-size:0.8em;">${r.name}</td>`;
        
        // 各ヒートの表示（カットされたものにクラス付与）
        let sortedForCut = r.pts.map((val, idx) => ({val, idx})).sort((a,b) => b.val - a.val);
        let cutCount = (r.pts.length >= c2) ? 2 : (r.pts.length >= c1 ? 1 : 0);
        let cutIndices = sortedForCut.slice(0, cutCount).map(x => x.idx);
        
        r.pts.forEach((pt, i) => {
            let isCut = cutIndices.includes(i);
            html += `<td class="${isCut?'cut':''} ${pt>=dns?'dns':''}">${pt}</td>`;
        });
        
        html += `<td class="cut">${r.cutPts[0]||''}</td><td class="cut">${r.cutPts[1]||''}</td><td style="font-weight:bold; background:#fff9c4;">${r.net}</td></tr>`;
    });
    document.getElementById('tableContainer').innerHTML = `<div class="table-wrapper">${html}</table></div>`;
}

window.onload = loadFromLocal;
</script>
</body>
</html>