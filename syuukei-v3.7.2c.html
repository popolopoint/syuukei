<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>集計ちゃん v3.7.2c</title>
<style>
  /* 全体の文字サイズを大きく（スマホで見やすく） */
  body { font-size: 20px; font-family: sans-serif; padding: 15px; line-height: 1.4; background-color: #f9f9f9; color: #333; }
  
  .table-wrapper { overflow-x: auto; margin-top: 20px; background: white; border: 1px solid #999; }
  table { border-collapse: collapse; width: max-content; font-size: 22px; } /* 表の文字を大きく */
  th, td { border: 1px solid #999; padding: 12px 10px; text-align: center; white-space: nowrap; }
  th { background-color: #eee; }
  
  .save-panel { background:#e3f2fd; padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid #2196F3; display: flex; gap: 5px; }
  
  /* ボタンを大きく押しやすく */
  button { font-size: 18px; padding: 15px; margin: 5px 2px; cursor: pointer; border-radius: 10px; border: 1px solid #666; background-color: #f0f0f0; font-weight: bold; touch-action: manipulation; }
  
  .calc-btn { background:#FF9800 !important; color:white !important; border:none !important; width:100%; margin-bottom: 10px; }
  .csv-btn { background:#2E7D32 !important; color:white !important; border:none !important; flex: 1; font-size: 16px; }
  .copy-btn { background:#00B900 !important; color:white !important; border:none !important; flex: 1; font-size: 16px; }
  
  .cut { color: blue; font-weight: bold; opacity: 0.6; }
  .dns { color: red; font-weight: bold; }

  /* モーダル（入力画面）の設定 */
  .modal { display:none; position:fixed; top:5%; left:50%; transform:translateX(-50%); border:2px solid #666; padding:20px; background:#fff; z-index: 2000; width: 85%; max-height: 85vh; overflow-y: auto; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .modal h3 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; }
  textarea { width: 100%; height: 200px; font-size: 18px; padding: 10px; box-sizing: border-box; }
  .rank-row { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
  .mRankInput { font-size: 20px; padding: 10px; width: 60%; }
</style>
</head>
<body>

<h3>集計ちゃん <span style="font-size:0.7em;">v3.7.2c</span></h3>

<div class="save-panel">
  <button onclick="saveToFile()" style="flex:1;">保存</button>
  <button onclick="document.getElementById('fileInput').click()" style="flex:1;">読込</button>
  <button onclick="clearAllData()" style="background:#f44336; color:white; flex:0.5;">消去</button>
  <input type="file" id="fileInput" style="display:none" onchange="loadFromFile(event)">
</div>

<div style="background:#eee; padding:15px; border-radius:8px;">
  <strong>種目設定:</strong>
  <select id="discipline" onchange="forceRecalc();" style="width:100%; padding:12px; font-size:20px; font-weight:bold; margin: 10px 0;">
    <option value="yacht">ウイング / ヨット（付則A）</option>
    <option value="wind">ウインドサーフィン（付則B）</option>
  </select>
  <div>
    カット枚数設定:<br>
    1枚目:<input type="number" id="cut1Heat" value="4" style="font-size:20px; width:50px;">回目から / 
    2枚目:<input type="number" id="cut2Heat" value="7" style="font-size:20px; width:50px;">回目から
    <button onclick="openModal('tieBreakModal')" style="padding:5px 10px; font-size:14px; margin-left:10px;">タイ解説</button>
  </div>
</div>

<div style="margin-top:15px;">
  <button onclick="openPartModal()" style="background:#f44336; color:white; width:100%;">選手名を入力（一括）</button>
  <input type="text" id="participantList" placeholder="例: J1 太郎, J2 花子" style="width: 100%; padding:12px; font-size:18px; margin-top:5px; box-sizing:border-box;">
  
  <button onclick="forceRecalc()" class="calc-btn">【 1 】 表を計算・更新</button>
  
  <div style="display: flex; gap:10px;">
    <button onclick="exportCSV()" class="csv-btn">【 2 】 CSV送信<br>(スプレッド用)</button>
    <button onclick="copyForLine()" class="copy-btn">【 2 】 LINE用コピー<br>(デカ文字速報用)</button>
  </div>
</div>

<hr>
<button onclick="openManualHeat()" style="background-color: #9C27B0; color:white; width:100%; padding: 20px;">＋ 着順を手入力</button>

<div id="tableContainer"></div>

<div id="tieBreakModal" class="modal">
    <h3>タイブレークの優先順位</h3>
    <div style="font-size: 18px;">
      <p><strong>【ウイング/ヨット（付則A）】</strong><br>
      1. Net（除外後）合計<br>
      2. 除外分をのぞくスコアを<b>「良い順」</b>に比較<br>
      3. 全ヒートの<b>「最新ヒート」</b>から遡って比較</p>
      <hr>
      <p><strong>【ウインド（付則B）】</strong><br>
      1. Net（除外後）合計<br>
      2. <b>「除外された点数」</b>が良い方が上位<br>
      3. 全スコアを<b>「良い順」</b>に比較<br>
      4. 全ヒートの<b>「最新ヒート」</b>から遡って比較</p>
    </div>
    <button onclick="closeModal('tieBreakModal')" style="width:100%; background:#ddd;">閉じる</button>
</div>

<div id="partModal" class="modal">
    <h3>選手名入力（カンマまたは改行区切り）</h3>
    <textarea id="partTextArea" placeholder="J1 太郎&#10;J2 花子"></textarea>
    <button onclick="submitPartModal()" style="width:100%; background:#4CAF50; color:white; padding:15px;">反映する</button>
    <button onclick="closeModal('partModal')" style="width:100%; margin-top:10px;">キャンセル</button>
</div>

<div id="manualHeatModal" class="modal">
    <h3>着順入力</h3>
    <div id="manualHeatInputs"></div>
    <button onclick="addRankInput()" style="width:100%; background:#eee; border:1px dashed #999;">+ 次の順位を追加</button>
    <button onclick="submitManualHeat()" style="width:100%; background:#4CAF50; color:white; margin-top:15px; padding:15px;">ヒート結果を保存</button>
    <button onclick="closeModal('manualHeatModal')" style="width:100%; margin-top:10px;">閉じる</button>
</div>

<div id="heatActionModal" class="modal">
    <h3 id="heatActionTitle">ヒート操作</h3>
    <button onclick="moveHeat(-1)" style="width:45%; background:#2196F3; color:white;">← 左へ移動</button>
    <button onclick="moveHeat(1)" style="width:45%; background:#2196F3; color:white;">右へ移動 →</button>
    <hr>
    <button style="width:100%; background:#4CAF50; color:white;" onclick="startHeatEdit()">このヒートを修正</button>
    <button style="width:100%; background:#f44336; color:white; margin-top:10px;" onclick="confirmDeleteHeat()">このヒートを削除</button>
    <button style="width:100%; margin-top:15px; background:#ddd;" onclick="closeModal('heatActionModal')">閉じる</button>
</div>

<script>
let results = {}; let participants = []; let heats = []; 
let targetHeatIndex = -1; let isEditMode = false; let lastScoredData = [];

// モーダル制御
function openModal(id) { document.getElementById(id).style.display = 'block'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }

// 共通処理
function forceRecalc() { applyParticipantsFromInput(); updateTable(); saveToLocal(); }
function saveToLocal() { const data = { results, heats, participantList: document.getElementById('participantList').value, discipline: document.getElementById('discipline').value, cut1: document.getElementById('cut1Heat').value, cut2: document.getElementById('cut2Heat').value }; localStorage.setItem('sailing_v372c', JSON.stringify(data)); }
function loadFromLocal() { const saved = localStorage.getItem('sailing_v372c'); if (saved) { const data = JSON.parse(saved); results = data.results || {}; heats = data.heats || []; document.getElementById('participantList').value = data.participantList || ""; document.getElementById('discipline').value = data.discipline || "yacht"; document.getElementById('cut1Heat').value = data.cut1 || "4"; document.getElementById('cut2Heat').value = data.cut2 || "7"; forceRecalc(); } }
function saveToFile() { saveToLocal(); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([localStorage.getItem('sailing_v372c')], {type: 'application/json'})); a.download = `sailing_backup.json`; a.click(); }
function loadFromFile(event) { const reader = new FileReader(); reader.onload = (e) => { localStorage.setItem('sailing_v372c', e.target.result); loadFromLocal(); }; reader.readAsText(event.target.files[0]); }
function clearAllData() { if(confirm("全データを消去してリセットしますか？")) { localStorage.removeItem('sailing_v372c'); location.reload(); } }

// 選手管理
function applyParticipantsFromInput(){
    const text = document.getElementById('participantList').value.trim();
    if(!text) { participants=[]; return; }
    participants = text.split(',').map(item => { item = item.trim(); const firstSpace = item.search(/\s/); const no = (firstSpace === -1) ? item : item.substring(0, firstSpace).trim(); return { no: no, fullName: item }; });
    const dns = participants.length + 1;
    participants.forEach(p => { if(!results[p.no]) results[p.no] = Array(heats.length).fill(dns); });
}
function openPartModal() { 
    document.getElementById('partTextArea').value = document.getElementById('participantList').value.split(',').map(s=>s.trim()).join('\n');
    openModal('partModal'); 
}
function submitPartModal() { 
    document.getElementById('participantList').value = document.getElementById('partTextArea').value.split('\n').filter(l=>l.trim()).join(', '); 
    forceRecalc(); closeModal('partModal'); 
}

// ヒート入力
function openManualHeat(){
    const container = document.getElementById('manualHeatInputs'); container.innerHTML = ''; 
    if(isEditMode) {
        let entries = participants.map(p => ({no: p.no, r: results[p.no][targetHeatIndex]})).filter(e => e.r <= participants.length).sort((a,b)=>a.r-b.r);
        if(entries.length > 0) entries.forEach(e => addRankInput(e.no)); else addRankInput();
    } else { addRankInput(); }
    openModal('manualHeatModal');
}
function addRankInput(pNo = ""){
    const container = document.getElementById('manualHeatInputs');
    const rank = container.querySelectorAll('.rank-row').length + 1;
    const div = document.createElement('div');
    div.className = 'rank-row';
    div.innerHTML = `<span>${rank}位:</span><input type="text" class="mRankInput" value="${pNo}">`;
    container.appendChild(div);
    div.querySelector('input').focus();
}
function submitManualHeat(){
    const inputs = document.getElementsByClassName('mRankInput');
    const pts = {}; let rank = 1;
    for(let i=0; i<inputs.length; i++){
        let val = inputs[i].value.trim().toUpperCase();
        if(val!==""){ const realP = participants.find(p => p.no.toUpperCase() === val); if(realP) { pts[realP.no] = rank; rank++; } }
    }
    const dns = participants.length + 1;
    if(isEditMode){ participants.forEach(p => results[p.no][targetHeatIndex] = pts[p.no] || dns); }
    else { heats.push("H"); participants.forEach(p => { if(!results[p.no]) results[p.no] = []; results[p.no].push(pts[p.no] || dns); }); }
    closeModal('manualHeatModal'); isEditMode = false; forceRecalc();
}

// ヒート操作
function openHeatActionModal(i) { targetHeatIndex = i; document.getElementById('heatActionTitle').textContent = `H${i+1} ヒート操作`; openModal('heatActionModal'); }
function startHeatEdit() { isEditMode=true; closeModal('heatActionModal'); openManualHeat(); }
function confirmDeleteHeat() { if(confirm(`H${targetHeatIndex+1}を削除しますか？`)) { heats.splice(targetHeatIndex, 1); for(let no in results) results[no].splice(targetHeatIndex, 1); forceRecalc(); } closeModal('heatActionModal'); }
function moveHeat(direction) {
    let newIdx = targetHeatIndex + direction;
    if(newIdx < 0 || newIdx >= heats.length) return;
    for(let no in results) { let tmp = results[no][targetHeatIndex]; results[no][targetHeatIndex] = results[no][newIdx]; results[no][newIdx] = tmp; }
    targetHeatIndex = newIdx; forceRecalc(); closeModal('heatActionModal');
}

// 計算・集計
function updateTable(){
    const disc = document.getElementById('discipline').value;
    const c1 = parseInt(document.getElementById('cut1Heat').value) || 99;
    const c2 = parseInt(document.getElementById('cut2Heat').value) || 99;
    const dns = participants.length + 1;
    
    let scoringData = participants.map(p => {
        let pts = (results[p.no] || []).map(v => (v > participants.length ? dns : v));
        let sortedForCut = pts.map((val, idx) => ({val, idx})).sort((a,b) => b.val - a.val);
        let cutCount = (pts.length >= c2) ? 2 : (pts.length >= c1 ? 1 : 0);
        let cutIndices = sortedForCut.slice(0, cutCount).map(x => x.idx);
        let netScore = 0, nonCutPts = [], cutPts = [];
        pts.forEach((pt, i) => {
            if(cutIndices.includes(i)) { cutPts.push(pt); }
            else { netScore += pt; nonCutPts.push(pt); }
        });
        return { no: p.no, name: p.fullName, pts, net: netScore, cutPts, nonCutPts, total: pts.reduce((a,b)=>a+b,0) };
    });

    scoringData.sort((a,b) => {
        if(a.net !== b.net) return a.net - b.net;
        if(disc==='yacht'){
            let aS = [...a.nonCutPts].sort((x,y)=>x-y), bS = [...b.nonCutPts].sort((x,y)=>x-y);
            for(let i=0; i<aS.length; i++) if(aS[i] !== bS[i]) return aS[i] - bS[i];
        } else {
            let acS = [...a.cutPts].sort((x,y)=>x-y), bcS = [...b.cutPts].sort((x,y)=>x-y);
            for(let i=0; i<acS.length; i++) if(acS[i] !== bcS[i]) return acS[i] - bcS[i];
            let apS = [...a.pts].sort((x,y)=>x-y), bpS = [...b.pts].sort((x,y)=>x-y);
            for(let i=0; i<apS.length; i++) if(apS[i] !== bpS[i]) return apS[i] - bpS[i];
        }
        for(let i=a.pts.length-1; i>=0; i--) if(a.pts[i] !== b.pts[i]) return a.pts[i] - b.pts[i];
        return 0;
    });

    lastScoredData = scoringData;
    let html = `<table><tr><th>順位</th><th>No.</th><th>Name</th>`;
    heats.forEach((_, i) => html += `<th onclick="openHeatActionModal(${i})">H${i+1}</th>`);
    html += `<th>Net</th></tr>`;
    scoringData.forEach((r, idx) => {
        html += `<tr><td style="font-weight:bold;">${idx+1}</td><td>${r.no}</td><td style="text-align:left;">${r.name}</td>`;
        let sortedForCut = r.pts.map((val, idx) => ({val, idx})).sort((a,b) => b.val - a.val);
        let cutCount = (r.pts.length >= c2) ? 2 : (r.pts.length >= c1 ? 1 : 0);
        let cutIndices = sortedForCut.slice(0, cutCount).map(x => x.idx);
        r.pts.forEach((pt, i) => {
            let isCut = cutIndices.includes(i);
            html += `<td class="${isCut?'cut':''} ${pt>=dns?'dns':''}">${pt}</td>`;
        });
        html += `<td style="font-weight:bold; background:#fff9c4;">${r.net}</td></tr>`;
    });
    document.getElementById('tableContainer').innerHTML = `<div class="table-wrapper">${html}</table></div>`;
}

// 共有機能
function exportCSV() {
    let csvRows = ["\uFEFFRank,No.,Name," + heats.map((_,i)=>`H${i+1}`).join(",") + ",Total,Net"];
    lastScoredData.forEach((r, idx) => {
        csvRows.push(`${idx+1},${r.no},"${r.name}",${r.pts.join(",")},${r.total},${r.net}`);
    });
    const blob = new Blob([csvRows.join("\n")], { type: 'text/csv' });
    if (navigator.share) {
        navigator.share({ files: [new File([blob], "result.csv", { type: 'text/csv' })], title: '結果送信' });
    } else {
        const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "result.csv"; link.click();
    }
}

function copyForLine() {
    let text = `【結果速報】\n`;
    lastScoredData.forEach((r, idx) => { text += `${idx+1}位 ${r.no} ${r.name} (${r.net}点)\n`; });
    navigator.clipboard.writeText(text).then(() => alert("LINE用テキストをコピーしました！"));
}

window.onload = loadFromLocal;
</script>
</body>
</html>