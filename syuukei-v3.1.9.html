<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>集計ちゃん v3.1.9</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  .table-wrapper { overflow-x: auto; }
  table { 
      border-collapse: collapse; 
      table-layout: fixed;
      width: max-content;
  }
  th, td { 
      border: 1px solid #999; 
      padding: 5px 10px; 
      text-align: center; 
      white-space: nowrap; 
      width: 80px; 
  }
  th { background-color: #eee; cursor: pointer; }
  input { margin-bottom: 10px; margin-right: 10px; }
  .dns { color: red; font-weight: bold; }
  .cut { color: blue; font-weight: bold; }




button {
    font-size: 1.1em;     /* ボタン文字を少し大きく */
    padding: 12px 20px;   /* 縦横のタップ領域を広く */
    margin: 5px 3px;      /* ボタン間の余白 */
    min-width: 120px;     /* ボタン幅の最低サイズ */
    cursor: pointer;
    border-radius: 6px;
    border: 1px solid #666;
    background-color: #f0f0f0;
}

button:active {
    background-color: #ddd;
}


/* すべてのボタン */
button {
    font-size: 1.2em;       /* 文字を大きく */
    padding: 14px 24px;     /* 縦横のタップ領域を広く */
    margin: 5px 5px;        /* ボタン間の余白 */
    min-width: 140px;       /* 横幅最低値 */
    cursor: pointer;
    border-radius: 6px;
    border: 1px solid #666;
    background-color: #f0f0f0;
}

button:active {
    background-color: #ddd;
}

/* ファイル選択と種目選択も大きく */
select, input[type="file"], input[type="text"], input[type="number"] {
    font-size: 1.1em;
    padding: 10px;
    min-width: 140px;
    margin: 5px 5px;
    border-radius: 5px;
    border: 1px solid #999;
    box-sizing: border-box;
}






</style>
</head>
<body>

<h2>集計ちゃん  <span style="font-size:0.7em;">by Popolo v3.1.9</h2></span>


<label>種目: 
  <select id="discipline">
    <option value="yacht">ヨット／ウイングフォイル</option>
    <option value="wind">ウインドサーフィン</option>
  </select>
</label>
<br><br>

<label>カット設定（ヒート数を入力）:</label><br>
1カットヒート: <input type="number" id="cut1Heat" placeholder="例: 4" style="width:60px; height:2em; text-align:center;">
2カットヒート: <input type="number" id="cut2Heat" placeholder="例: 8" style="width:60px; height:2em; text-align:center;">
<br><br>

<label>参加選手番号（カンマ区切り）:</label>
<input type="text" id="participantList" placeholder="001,002,003,004" style="width:200px;">
<span id="participantCount" style="margin-left:10px;">0名</span>
<button id="loadParticipantBtn">参加選手リストの読取</button>
<br><br>
<input type="file" id="participantCSV" accept=".csv" style="display:none">

<br><br>
<input type="file" id="csvFile" accept=".csv">
<button onclick="handleCSV()">ヒート追加</button>
<button onclick="downloadCSV()">総合結果をCSV出力</button>

<div id="tableContainer"></div>

<script>
let results = {};
let heats = [];
let cutSettings = {};
let participants = [];
let seriesCount = 0;
let currentSortAsc = true;

// --- 参加者CSV読取 ---
document.getElementById('loadParticipantBtn').addEventListener('click', () => {
    document.getElementById('participantCSV').click();
});

document.getElementById('participantCSV').addEventListener('change', () => {
    const fileInput = document.getElementById('participantCSV');
    if(!fileInput.files.length){ alert('CSVを選択してください'); return; }

    const reader = new FileReader();
    reader.onload = function(e){
        const text = e.target.result;
        const lines = text.trim().split(/\r?\n/);
        if(lines.length < 2){ alert('CSVの内容が不十分です'); return; }

        const participantsArr = [];
        for(let i=1; i<lines.length; i++){
            const cols = lines[i].split(',');
            if(cols.length < 1) continue;
            const number = cols[0].trim();
            if(number) participantsArr.push(number);
        }

        document.getElementById('participantList').value = participantsArr.join(',');
        document.getElementById('participantCount').textContent = `${participantsArr.length}名`;
    };
    reader.readAsText(fileInput.files[0], 'utf-8');
});

// --- CSV処理 ---
function handleCSV(){
    const fileInput = document.getElementById('csvFile');
    if(!fileInput.files.length){ alert('CSVを選択してください'); return; }

    const participantText = document.getElementById('participantList').value.trim();
    if(!participantText){ alert('参加選手番号を入力してください'); return; }
    participants = participantText.split(',').map(s=>s.trim());
    seriesCount = participants.length;

    participants.forEach(name=>{
        if(!results[name]) results[name] = Array(heats.length).fill(seriesCount + 1);
    });

    const reader = new FileReader();
    reader.onload = function(e){
        const text = e.target.result;
        parseCSV(text);
        updateTable();
    };
    reader.readAsText(fileInput.files[0], 'utf-8');
}

function parseCSV(text){
    const lines = text.trim().split(/\r?\n/);
    if(lines.length < 2) return;
    let heatName = "Heat" + (heats.length + 1);
    heats.push(heatName);

    let heatPoints = {};
    for(let i=1;i<lines.length;i++){
        const cols = lines[i].split(',');
        if(cols.length < 3) continue;
        const rankStr = cols[1].trim();
        const colorNumber = cols[2].trim();
        if(!participants.includes(colorNumber)) continue;
        let rank = parseInt(rankStr,10);
        heatPoints[colorNumber] = !isNaN(rank) ? rank : seriesCount + 1;
    }

    participants.forEach(name=>{
        if(!results[name]) results[name] = Array(heats.length - 1).fill(seriesCount + 1);
        results[name].push(heatPoints[name] !== undefined ? heatPoints[name] : seriesCount + 1);
    });
}

// --- ネットポイント計算 ---
function getCutCount(heatCount){
    let count = 0;
    for(let key of Object.keys(cutSettings).sort((a,b)=>a-b)){
        if(heatCount >= key) count = cutSettings[key];
    }
    return count;
}

function calculateNetPoints(){
    let netResults = {};
    const discipline = document.getElementById('discipline').value;

    for(let name of participants){
        let points = results[name].slice();
        let cutCount = getCutCount(points.length);
        let cuts = [];

        if(cutCount > 0){
            let sorted = points.map((p,i)=>({p,i})).sort((a,b)=>b.p - a.p);
            cuts = sorted.slice(0,cutCount).map(c=>c.p);
        }

        let totalPoints = points.reduce((a,b)=>a+b,0);
        let netPoints = totalPoints - cuts.reduce((a,b)=>a+b,0);
        netResults[name] = {points, cuts, net: netPoints, total: totalPoints};
    }

    let sortedNames = participants.slice();
    sortedNames.sort((a,b)=>{
        let na = netResults[a].net;
        let nb = netResults[b].net;
        if(na !== nb) return na - nb;
        return discipline === "yacht" ? yachtTieBreaker(netResults[a], netResults[b])
                                      : windTieBreaker(netResults[a], netResults[b]);
    });

    let rank = 1;
    let finalResults = {};
    sortedNames.forEach(name=>{
        finalResults[name] = {...netResults[name], rank: rank++};
    });

    return finalResults;
}

function yachtTieBreaker(a,b){
    let aPoints = a.points.slice(0, a.points.length - a.cuts.length);
    let bPoints = b.points.slice(0, b.points.length - b.cuts.length);
    for(let i=0;i<Math.min(aPoints.length,bPoints.length);i++){
        if(aPoints[i] !== bPoints[i]) return aPoints[i]-bPoints[i];
    }
    let aAll = a.points;
    let bAll = b.points;
    for(let i=aAll.length-1;i>=0;i--){
        if(aAll[i] !== bAll[i]) return aAll[i]-bAll[i];
    }
    return 0;
}

function windTieBreaker(a,b){
    let aCuts = a.cuts.slice().sort((x,y)=>x-y);
    let bCuts = b.cuts.slice().sort((x,y)=>x-y);
    for(let i=0;i<Math.min(aCuts.length,bCuts.length);i++){
        if(aCuts[i] !== bCuts[i]) return aCuts[i]-bCuts[i];
    }
    let aAll = a.points.slice().sort((x,y)=>x-y);
    let bAll = b.points.slice().sort((x,y)=>x-y);
    for(let i=0;i<Math.min(aAll.length,bAll.length);i++){
        if(aAll[i] !== bAll[i]) return aAll[i]-bAll[i];
    }
    for(let i=a.points.length-1;i>=0;i--){
        if(a.points[i] !== b.points[i]) return a.points[i]-b.points[i];
    }
    return 0;
}

// --- 表更新 ---
function updateTable(){
    cutSettings = {};
    const cut1 = parseInt(document.getElementById('cut1Heat').value);
    const cut2 = parseInt(document.getElementById('cut2Heat').value);
    if(!isNaN(cut1)) cutSettings[cut1] = 1;
    if(!isNaN(cut2)) cutSettings[cut2] = 2;

    const finalResults = calculateNetPoints();

    let html = "<table id='resultsTable'><tr>";
    html += "<th onclick='sortTable()'>順位 ↑↓</th>";
    html += "<th>選手名</th>";
    heats.forEach(h=>html += `<th>${h}</th>`);
    html += "<th>カット前合計</th>";

    let maxCut = Math.max(...Object.values(cutSettings),0);
    for(let i=1;i<=maxCut;i++){
        html += `<th>カット${i}</th>`;
    }
    html += "<th>Net</th></tr>";

    for(let name of participants){
        let r = finalResults[name];
        html += `<tr>`;
        html += `<td>${r.rank}</td><td>${name}</td>`;

        r.points.forEach(p=>{
            let display = (p === seriesCount + 1) ? `<span class='dns'>${p}</span>` : p;
            html += `<td>${display}</td>`;
        });

        html += `<td>${r.total}</td>`;

        for(let i=0;i<maxCut;i++){
            let cutVal = r.cuts[i] !== undefined ? `<span class='cut'>${r.cuts[i]}</span>` : "";
            html += `<td>${cutVal}</td>`;
        }

        html += `<td>${r.net}</td></tr>`;
    }

    document.getElementById('tableContainer').innerHTML = "<div class='table-wrapper'>" + html + "</div>";

    // --- ヒート削除イベント再設定 ---
    makeHeatColumnsRemovable();
}

// --- ヒート列削除機能 ---
function makeHeatColumnsRemovable(){
    const table = document.getElementById('resultsTable');
    if(!table) return;

    const headerCells = table.rows[0].cells;
    for(let i=0;i<headerCells.length;i++){
        if(headerCells[i].textContent.includes("Heat")){
            headerCells[i].style.cursor = "pointer";
            headerCells[i].title = "クリックで削除";
            headerCells[i].onclick = function(){
                if(!confirm(`"${headerCells[i].textContent}" を削除しますか？`)) return;

                const heatIndex = i - 2;
                if(heatIndex >= 0 && heatIndex < heats.length){
                    heats.splice(heatIndex, 1);
                    participants.forEach(name => {
                        if(results[name] && results[name].length > heatIndex){
                            results[name].splice(heatIndex, 1);
                        }
                    });
                }

                updateTable();
            }
        }
    }
}

// --- 順位ソート ---
function sortTable(){
    const table = document.getElementById('resultsTable');
    const rows = Array.from(table.rows).slice(1);
    rows.sort((a,b)=>{
        const valA = parseInt(a.cells[0].textContent);
        const valB = parseInt(b.cells[0].textContent);
        return currentSortAsc ? valA - valB : valB - valA;
    });
    currentSortAsc = !currentSortAsc;
    rows.forEach(r=>table.appendChild(r));
}

// --- CSV出力 ---
function downloadCSV(){
    const finalResults = calculateNetPoints();
    let csv = "順位,選手名,カット前合計," + heats.join(",") + ",カット,Net\n";
    for(let name of participants){
        let r = finalResults[name];
        csv += `${r.rank},${name},${r.total},${r.points.join(",")},(${r.cuts.join(',')}),${r.net}\n`;
    }
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "総合結果_v3.1.7.csv";
    a.click();
    URL.revokeObjectURL(url);
}
</script>
</body>
</html>
