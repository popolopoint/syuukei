<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>集計ちゃん by Popolo v3.7.1c</title>
<style>
  body { font-family: sans-serif; padding: 20px; line-height: 1.4; background-color: #f9f9f9; }
  .table-wrapper { overflow-x: auto; margin-top: 20px; background: white; border: 1px solid #999; }
  table { border-collapse: collapse; table-layout: fixed; width: max-content; }
  th, td { border: 1px solid #999; padding: 6px 10px; text-align: center; white-space: nowrap; width: 100px; }
  th { background-color: #eee; cursor: pointer; }
  .dns { color: red; font-weight: bold; }
  .cut { color: blue; font-weight: bold; }

  button {
      font-size: 1.1em; padding: 12px 20px; margin: 5px 2px;
      min-width: 130px; cursor: pointer; border-radius: 6px;
      border: 1px solid #666; background-color: #f0f0f0;
  }
  button:active { background-color: #ddd; }

  select, input[type="text"], input[type="number"], textarea {
      font-size: 1.1em; padding: 10px; margin: 5px;
      border-radius: 5px; border: 1px solid #999; box-sizing: border-box;
  }

  /* カラー設定 */
  #handleCSVBtn { background-color: #4CAF50; color: white; }
  #downloadCSVBtn { background-color: #2196F3; color: white; }
  #recalcBtn { background-color: #FF9800; color: white; }
  #manualHeatBtn { background-color: #9C27B0; color: white; }
  #manualPartBtn { background-color: #f44336; color: white; border: none; }
  #tieBreakBtn { background-color: #607D8B; color: white; min-width: auto; padding: 8px 15px; font-size: 0.9em; }

  .modal {
      display:none; position:fixed; top:5%; left:50%; transform:translateX(-50%);
      border:1px solid #999; padding:20px; background:#fff; z-index: 2000;
      width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  }
</style>
</head>
<body>

<h2>集計ちゃん <span style="font-size:0.7em;">by Popolo v3.7.1c</span></h2>

<label>種目: 
  <select id="discipline">
    <option value="wind">ウインドサーフィン</option>
    <option value="yacht">ウイングフォイル/ヨット</option>
  </select>
</label>
<button id="tieBreakBtn" onclick="openTieBreakModal()">タイの解き方</button>
<br><br>

<label>カット設定:</label><br>
1枚カット: <input type="number" id="cut1Heat" value="4" style="width:70px; text-align:center;">
2枚カット: <input type="number" id="cut2Heat" value="7" style="width:70px; text-align:center;">

<br><br>

<button id="manualPartBtn" onclick="openPartModal()">選手入力、文字も入力</button>

<br>
<label>参加選手（カンマ区切り）:</label><br>
<input type="text" id="participantList" placeholder="001 Name, 002 Name" style="width: 80%;">
<span id="participantCount" style="font-weight:bold;">0名</span>

<br><br>
<button id="csvFileBtn" style="font-size:0.8em; min-width:100px;">ヒートCSV読取</button>
<input type="file" id="csvFile" accept=".csv" style="display:none;">

<br><br>
<button id="handleCSVBtn" onclick="handleCSV()">ヒート追加（CSV）</button>
<button id="manualHeatBtn" onclick="openManualHeat()">ヒート手入力</button>
<br>
<label>大会名:</label>
<input type="text" id="resultName" placeholder="大会名" style="width:200px;">
<br>
<button id="downloadCSVBtn" onclick="downloadCSV()">CSV出力</button>
<button id="recalcBtn" onclick="applyParticipantsFromInput()">表を更新・再計算</button>

<div id="tableContainer"></div>

<div id="tieBreakModal" class="modal" style="z-index: 3000;">
    <h3>タイの解き方</h3>
    <div style="font-size: 0.9em; line-height: 1.6;">
        <p><strong>RRS付則A（ヨット・ウイング）</strong><br>
        → カットを含まない得点を良順に比較<br>
        → カットを含め、最終レースから逆順に比較</p>
        <p><strong>付則B（ウインドサーフィン）</strong><br>
        → カットされた得点を比較<br>
        → カットを含む得点を良順に比較<br>
        → カットを含め、最終レースから逆順に比較</p>
    </div>
    <button style="width:100%; margin-top:10px;" onclick="closeTieBreakModal()">閉じる</button>
</div>

<div id="partModal" class="modal">
    <h3>選手入力、文字も入力</h3>
    <p style="font-size:0.8em; color:#666;">「番号 名前」の形式で1行ずつ入力してください。<br>例: 001 Taro Popolo</p>
    <textarea id="partTextArea" style="width:100%; height:250px;"></textarea>
    <button onclick="submitPartModal()" style="width:100%; background:#4CAF50; color:white; margin-top:10px;">反映する</button>
    <button style="width:100%; margin-top:5px;" onclick="closePartModal()">キャンセル</button>
</div>

<div id="heatActionModal" class="modal" style="z-index: 2500;">
    <h3 id="heatActionTitle">操作</h3>
    <button style="width:100%; margin-bottom:10px; background:#4CAF50; color:white;" onclick="startHeatEdit()">修正する</button>
    <button style="width:100%; margin-bottom:10px; background:#f44336; color:white;" onclick="confirmDeleteHeat()">削除する</button>
    <button style="width:100%;" onclick="closeHeatActionModal()">キャンセル</button>
</div>

<div id="manualHeatModal" class="modal">
    <h3 id="manualHeatModalTitle">順位入力</h3>
    <div id="manualHeatInputs"></div>
    <button id="manualAddBtn" style="width:100%;">順位を追加</button>
    <button onclick="submitManualHeat()" style="width:100%; background:#4CAF50; color:white; margin-top:10px;">確定保存</button>
    <button style="width:100%; margin-top:5px;" onclick="closeManualHeatModal()">キャンセル</button>
</div>

<script>
let results = {};      
let participants = []; 
let heats = [];        
let displayOrder = []; 
let currentSortAsc = true;
let targetHeatIndex = -1;
let isEditMode = false;

// --- 選手モーダル制御 ---
function openPartModal() {
    const list = document.getElementById('participantList').value;
    document.getElementById('partTextArea').value = list.split(',').map(s=>s.trim()).join('\n');
    document.getElementById('partModal').style.display = 'block';
}
function closePartModal() { document.getElementById('partModal').style.display = 'none'; }
function submitPartModal() {
    const text = document.getElementById('partTextArea').value;
    document.getElementById('participantList').value = text.split('\n').filter(s=>s.trim()!=='').join(', ');
    applyParticipantsFromInput();
    closePartModal();
}

// --- 選手入力の解析 ---
function applyParticipantsFromInput(){
    const text = document.getElementById('participantList').value.trim();
    if(!text) {
        participants = []; displayOrder = [];
        document.getElementById('participantCount').textContent = `0名`;
        updateTable(); return;
    }
    
    const rawList = text.split(',').map(s=>s.trim()).filter(s=>s!=='');
    const updated = rawList.map(item => {
        const firstSpace = item.search(/\s/);
        if(firstSpace === -1) return { no: item, fullName: item };
        return { 
            no: item.substring(0, firstSpace).trim(), 
            fullName: item.trim() 
        };
    });

    const newDNSPoint = updated.length + 1;
    updated.forEach(p => {
        if(!results[p.no]){
            results[p.no] = Array(heats.length).fill(newDNSPoint);
        }
    });

    participants = updated;
    displayOrder = [...participants];
    document.getElementById('participantCount').textContent = `${participants.length}名`;
    updateTable();
}

// --- モーダル制御 ---
function openTieBreakModal() { document.getElementById('tieBreakModal').style.display = 'block'; }
function closeTieBreakModal() { document.getElementById('tieBreakModal').style.display = 'none'; }
function openHeatActionModal(idx) {
    targetHeatIndex = idx;
    document.getElementById('heatActionTitle').textContent = `Heat ${idx+1} の操作`;
    document.getElementById('heatActionModal').style.display = 'block';
}
function closeHeatActionModal() { document.getElementById('heatActionModal').style.display = 'none'; }

// --- ヒートCSV追加 ---
document.getElementById('csvFileBtn').onclick = () => document.getElementById('csvFile').click();
function handleCSV(){
    const file = document.getElementById('csvFile').files[0];
    if(!file) return alert("ファイルを選択してください");
    applyParticipantsFromInput();
    const reader = new FileReader();
    reader.onload = (e) => {
        const lines = e.target.result.trim().split(/\r?\n/);
        heats.push("Heat " + (heats.length + 1));
        const heatPoints = {};
        lines.slice(1).forEach(l => {
            const c = l.split(',');
            if(c.length >= 3) heatPoints[c[2].trim()] = parseInt(c[1]);
        });
        participants.forEach(p => {
            results[p.no].push(heatPoints[p.no] || (participants.length + 1));
        });
        updateTable();
    };
    reader.readAsText(file);
}

// --- ヒート修正・削除 ---
function startHeatEdit() { isEditMode = true; closeHeatActionModal(); openManualHeat(); }
function confirmDeleteHeat() {
    if(confirm(`Heat ${targetHeatIndex+1}を削除しますか？`)) {
        heats.splice(targetHeatIndex, 1);
        for(let no in results) results[no].splice(targetHeatIndex, 1);
        updateTable();
    }
    closeHeatActionModal();
}

function openManualHeat(){
    const container = document.getElementById('manualHeatInputs');
    container.innerHTML = '';
    let nextR = 1;
    if(isEditMode) {
        document.getElementById('manualHeatModalTitle').textContent = `Heat ${targetHeatIndex+1} 修正`;
        let entries = participants.map(p => ({no: p.no, r: results[p.no][targetHeatIndex]}))
                                  .filter(e => e.r <= participants.length)
                                  .sort((a,b)=>a.r - b.r);
        entries.forEach(e => addRankInput(e.r, e.no));
        nextR = entries.length + 1;
    } else {
        document.getElementById('manualHeatModalTitle').textContent = `新規ヒート`;
        addRankInput(1);
    }
    document.getElementById('manualHeatModal').style.display = 'block';

    function addRankInput(rank, pNo = ""){
        const r = rank || nextR++;
        const div = document.createElement('div');
        div.style.marginBottom="5px";
        div.innerHTML = `${r}位: <input type="text" class="mRankInput" value="${pNo}" style="width:100px;">`;
        container.appendChild(div);
        div.querySelector('input').focus();
    }
    document.getElementById('manualAddBtn').onclick = () => addRankInput();
}

function submitManualHeat(){
    const inputs = document.querySelectorAll('.mRankInput');
    const points = {};
    inputs.forEach((inp, i) => { if(inp.value) points[inp.value.trim()] = i + 1; });
    const dns = participants.length + 1;

    if(isEditMode){
        participants.forEach(p => { results[p.no][targetHeatIndex] = points[p.no] || dns; });
    } else {
        heats.push("Heat " + (heats.length + 1));
        participants.forEach(p => { results[p.no].push(points[p.no] || dns); });
    }
    updateTable(); closeManualHeatModal();
}
function closeManualHeatModal(){ document.getElementById('manualHeatModal').style.display='none'; isEditMode=false; }

// --- 表示計算 ---
function updateTable(){
    const c1 = parseInt(document.getElementById('cut1Heat').value);
    const c2 = parseInt(document.getElementById('cut2Heat').value);
    const dns = participants.length + 1;

    let netRes = {};
    participants.forEach(p => {
        let pts = (results[p.no] || []).map(v => (v >= participants.length) ? dns : v);
        results[p.no] = pts;
        let sorted = [...pts].sort((a,b)=>b-a);
        let cutCount = (pts.length >= c2) ? 2 : (pts.length >= c1 ? 1 : 0);
        let cuts = sorted.slice(0, cutCount);
        let net = pts.reduce((a,b)=>a+b, 0) - cuts.reduce((a,b)=>a+b, 0);
        netRes[p.no] = { pts, net, total: pts.reduce((a,b)=>a+b,0), cuts };
    });

    let html = `<table><tr><th onclick="sortNet()">順位</th><th>No.</th><th>Name</th>`;
    heats.forEach((h, i) => html += `<th onclick="openHeatActionModal(${i})">${h}</th>`);
    html += `<th>Total</th><th>Net</th></tr>`;

    displayOrder.forEach((p, idx) => {
        const r = netRes[p.no];
        if(!r) return;
        html += `<tr><td>${idx+1}</td><td>${p.no}</td><td style="text-align:left;">${p.fullName.replace(p.no,'').trim()}</td>`;
        r.pts.forEach(pt => html += `<td class="${pt>=dns?'dns':''}">${pt}</td>`);
        html += `<td>${r.total}</td><td style="font-weight:bold;">${r.net}</td></tr>`;
    });
    document.getElementById('tableContainer').innerHTML = `<div class="table-wrapper">${html}</table></div>`;
}

function sortNet() {
    const c1 = parseInt(document.getElementById('cut1Heat').value);
    const c2 = parseInt(document.getElementById('cut2Heat').value);
    displayOrder.sort((a, b) => {
        const getNet = (pNo) => {
            let pts = results[pNo];
            let sorted = [...pts].sort((a,b)=>b-a);
            let cutCount = (pts.length >= c2) ? 2 : (pts.length >= c1 ? 1 : 0);
            return pts.reduce((x,y)=>x+y,0) - sorted.slice(0, cutCount).reduce((x,y)=>x+y,0);
        };
        return currentSortAsc ? getNet(a.no) - getNet(b.no) : getNet(b.no) - getNet(a.no);
    });
    currentSortAsc = !currentSortAsc;
    updateTable();
}

function downloadCSV() {
    let csv = "Rank,No,Name," + heats.join(",") + ",Total,Net\n";
    displayOrder.forEach((p, i) => {
        const r = results[p.no];
        csv += `${i+1},${p.no},${p.fullName.replace(p.no,'').trim()},${r.join(",")}\n`;
    });
    const blob = new Blob([csv], {type: 'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (document.getElementById('resultName').value || "result") + ".csv";
    a.click();
}

applyParticipantsFromInput();
</script>
</body>
</html>