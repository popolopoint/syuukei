<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>集計ちゃん v3.7.1i</title>
<style>
  body { font-family: sans-serif; padding: 15px; line-height: 1.4; background-color: #f9f9f9; color: #333; }
  .table-wrapper { overflow-x: auto; margin-top: 20px; background: white; border: 1px solid #999; -webkit-overflow-scrolling: touch; }
  table { border-collapse: collapse; table-layout: fixed; width: max-content; }
  th, td { border: 1px solid #999; padding: 10px 8px; text-align: center; white-space: nowrap; width: 90px; }
  th { background-color: #eee; position: sticky; top: 0; z-index: 10; }
  .dns { color: red; font-weight: bold; }
  .cut { color: blue; text-decoration: line-through; opacity: 0.5; }

  button {
      font-size: 1.0em; padding: 12px 15px; margin: 5px 2px;
      min-width: 120px; cursor: pointer; border-radius: 8px;
      border: 1px solid #666; background-color: #f0f0f0;
      touch-action: manipulation;
  }
  textarea, input[type="text"], input[type="number"] { font-size: 16px !important; }
  #recalcBtn { background-color: #FF9800; color: white; border: none; width: 100%; max-width: 300px; font-weight: bold; }
  
  .modal {
      display:none; position:fixed; top:5%; left:50%; transform:translateX(-50%);
      border:1px solid #999; padding:20px; background:#fff; z-index: 2000;
      width: 85%; max-width: 400px; max-height: 85vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      border-radius: 12px;
  }
  .rank-row { margin-bottom: 10px; display: flex; align-items: center; }
</style>
</head>
<body>

<h3>集計ちゃん <span style="font-size:0.7em;">v3.7.1i</span></h3>

<div>
  カット設定: 
  1枚: <input type="number" id="cut1Heat" value="4" style="width:45px;"> 
  2枚: <input type="number" id="cut2Heat" value="7" style="width:45px;">
</div>

<div style="margin-top:10px;">
  <button id="manualPartBtn" onclick="openPartModal()" style="background:#f44336; color:white; width:100%; max-width:300px;">選手入力、文字も入力</button>
  <input type="text" id="participantList" placeholder="001 Name, 002 Name" style="width: 100%; margin-top:5px;">
  <div id="participantCount" style="font-weight:bold; margin:5px 0; color:#2196F3;">0名 登録中</div>
  <button id="recalcBtn" onclick="applyParticipantsFromInput()">表を更新・再計算</button>
</div>

<hr>
<button onclick="document.getElementById('csvFile').click()">CSV読取</button>
<input type="file" id="csvFile" accept=".csv" style="display:none;" onchange="handleCSV()">
<button id="manualHeatBtn" onclick="openManualHeat()" style="background-color: #9C27B0; color:white; border:none;">ヒート手入力</button>

<div id="tableContainer"></div>

<div id="manualHeatModal" class="modal">
    <h3 id="manualHeatModalTitle">順位入力</h3>
    <div id="manualHeatInputs"></div>
    <button onclick="addRankInput()" style="width:100%; background:#eee; border:1px dashed #999; margin-top:5px;">+ 順位を追加</button>
    <button onclick="submitManualHeat()" style="width:100%; background:#4CAF50; color:white; margin-top:15px; padding:15px; border:none; font-weight:bold;">確定保存</button>
    <button style="width:100%; margin-top:10px;" onclick="closeManualHeatModal()">キャンセル</button>
</div>

<div id="heatActionModal" class="modal">
    <h3 id="heatActionTitle">操作</h3>
    <button style="width:100%; background:#4CAF50; color:white; padding:15px;" onclick="startHeatEdit()">修正する</button>
    <button style="width:100%; background:#f44336; color:white; padding:15px; margin-top:10px;" onclick="confirmDeleteHeat()">削除する</button>
    <button style="width:100%; margin-top:15px;" onclick="closeHeatActionModal()">キャンセル</button>
</div>

<script>
let results = {}; let participants = []; let heats = []; let displayOrder = [];
let targetHeatIndex = -1; let isEditMode = false; let currentSortAsc = true;

// 選手管理
function openPartModal() {
    const list = document.getElementById('participantList').value;
    const partTextArea = document.createElement('textarea'); // 一時的に作成
    const val = list.split(',').map(s=>s.trim()).filter(s=>s).join('\n');
    const text = prompt("選手リストを改行区切りで入力してください", val);
    if(text !== null) {
        document.getElementById('participantList').value = text.split('\n').filter(s=>s.trim()!=='').join(', ');
        applyParticipantsFromInput();
    }
}

function applyParticipantsFromInput(){
    const text = document.getElementById('participantList').value.trim();
    if(!text) { participants=[]; displayOrder=[]; updateTable(); return; }
    const rawList = text.split(',').map(s=>s.trim()).filter(s=>s!=='');
    participants = rawList.map(item => {
        const firstSpace = item.search(/\s/);
        const no = (firstSpace === -1) ? item : item.substring(0, firstSpace).trim();
        return { no: no, fullName: item.trim() };
    });
    const dns = participants.length + 1;
    participants.forEach(p => { if(!results[p.no]) results[p.no] = Array(heats.length).fill(dns); });
    displayOrder = [...participants];
    document.getElementById('participantCount').textContent = `${participants.length}名 登録中`;
    updateTable();
}

// ヒート入力
function openManualHeat(){
    const container = document.getElementById('manualHeatInputs');
    container.innerHTML = ''; 
    if(isEditMode) {
        let entries = participants.map(p => ({no: p.no, r: results[p.no][targetHeatIndex]}))
                                  .filter(e => e.r <= participants.length).sort((a,b)=>a.r-b.r);
        if(entries.length > 0) { entries.forEach(e => addRankInput(e.no)); } 
        else { addRankInput(); }
    } else { addRankInput(); }
    document.getElementById('manualHeatModal').style.display = 'block';
}

function addRankInput(pNo = ""){
    const container = document.getElementById('manualHeatInputs');
    const rank = container.querySelectorAll('.rank-row').length + 1;
    const div = document.createElement('div');
    div.className = 'rank-row';
    const inputId = `rank_input_${Date.now()}_${rank}`; // 重複しないID
    div.innerHTML = `<span style="width:50px; font-weight:bold;">${rank}位:</span> 
                     <input type="text" class="mRankInput" id="${inputId}" value="${pNo}" 
                            style="width:120px; padding:8px;" inputmode="numeric">`;
    container.appendChild(div);
    const inp = div.querySelector('input');
    inp.focus();
    
    // 改行イベント
    inp.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addRankInput();
        }
    });
}

function submitManualHeat(){
    // 全ての入力欄を強制的にスキャン
    const inputs = document.getElementsByClassName('mRankInput');
    const pts = {};
    let rankCounter = 1;
    
    for (let i = 0; i < inputs.length; i++) {
        const val = inputs[i].value.trim();
        if (val !== "") {
            pts[val] = rankCounter;
            rankCounter++;
        }
    }

    const dns = participants.length + 1;
    if(isEditMode){ 
        participants.forEach(p => { results[p.no][targetHeatIndex] = pts[p.no] || dns; }); 
    } else { 
        heats.push("H" + (heats.length + 1)); 
        participants.forEach(p => { 
            if(!results[p.no]) results[p.no] = Array(heats.length - 1).fill(dns);
            results[p.no].push(pts[p.no] || dns); 
        }); 
    }
    updateTable(); 
    closeManualHeatModal();
}

function closeManualHeatModal(){ document.getElementById('manualHeatModal').style.display='none'; isEditMode=false; }

function updateTable(){
    const c1 = parseInt(document.getElementById('cut1Heat').value) || 99;
    const c2 = parseInt(document.getElementById('cut2Heat').value) || 99;
    const dns = participants.length + 1;
    let netRes = {};

    participants.forEach(p => {
        let pts = (results[p.no] || []).map(v => (v >= participants.length) ? dns : v);
        let sorted = [...pts].sort((a,b)=>b-a);
        let cutCount = (pts.length >= c2) ? 2 : (pts.length >= c1 ? 1 : 0);
        let tempCuts = [...sorted.slice(0, cutCount)];
        let net = pts.reduce((a,b)=>a+b, 0) - tempCuts.reduce((a,b)=>a+b, 0);
        netRes[p.no] = { pts, net, cutVals: tempCuts };
    });

    let html = `<table><tr><th onclick="sortNet()">順位</th><th>No.</th><th>Name</th>`;
    heats.forEach((h, i) => html += `<th onclick="openHeatActionModal(${i})">${h}</th>`);
    html += `<th>Net</th></tr>`;

    displayOrder.forEach((p, idx) => {
        const r = netRes[p.no]; if(!r) return;
        html += `<tr><td>${idx+1}</td><td>${p.no}</td><td style="text-align:left; font-size:0.8em; overflow:hidden;">${p.fullName.replace(p.no,'').trim()}</td>`;
        let currentCuts = [...r.cutVals];
        r.pts.forEach(pt => {
            let cutIdx = currentCuts.indexOf(pt);
            if(cutIdx > -1) { currentCuts.splice(cutIdx, 1); html += `<td class="cut">${pt}</td>`; } 
            else { html += `<td class="${pt>=dns?'dns':''}">${pt}</td>`; }
        });
        html += `<td style="font-weight:bold; background:#fff9c4;">${r.net}</td></tr>`;
    });
    document.getElementById('tableContainer').innerHTML = `<div class="table-wrapper">${html}</table></div>`;
}

function openHeatActionModal(i) { targetHeatIndex = i; document.getElementById('heatActionModal').style.display='block'; }
function closeHeatActionModal() { document.getElementById('heatActionModal').style.display='none'; }
function startHeatEdit() { isEditMode = true; closeHeatActionModal(); openManualHeat(); }
function confirmDeleteHeat() {
    if(confirm(`Heat ${targetHeatIndex+1}を削除しますか？`)) {
        heats.splice(targetHeatIndex, 1);
        for(let no in results) results[no].splice(targetHeatIndex, 1);
        updateTable();
    }
    closeHeatActionModal();
}
function handleCSV(){
    const file = document.getElementById('csvFile').files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const lines = e.target.result.trim().split(/\r?\n/);
        heats.push("H" + (heats.length + 1));
        const pts = {};
        lines.slice(1).forEach(l => { const c = l.split(','); if(c.length>=3) pts[c[2].trim()]=parseInt(c[1]); });
        participants.forEach(p => { 
            if(!results[p.no]) results[p.no] = Array(heats.length - 1).fill(participants.length + 1);
            results[p.no].push(pts[p.no] || (participants.length + 1)); 
        });
        updateTable();
    };
    reader.readAsText(file);
    document.getElementById('csvFile').value = "";
}
function sortNet() {
    displayOrder.sort((a, b) => {
        const getNet = (pNo) => {
            let p = results[pNo];
            let sorted = [...p].sort((x,y)=>y-x);
            let c1 = parseInt(document.getElementById('cut1Heat').value) || 99;
            let c2 = parseInt(document.getElementById('cut2Heat').value) || 99;
            let cutCount = (p.length >= c2) ? 2 : (p.length >= c1 ? 1 : 0);
            return p.reduce((s,v)=>s+v,0) - sorted.slice(0, cutCount).reduce((s,v)=>s+v,0);
        };
        return currentSortAsc ? getNet(a.no) - getNet(b.no) : getNet(b.no) - getNet(a.no);
    });
    currentSortAsc = !currentSortAsc;
    updateTable();
}
window.onload = applyParticipantsFromInput;
</script>
</body>
</html>