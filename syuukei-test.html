<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>集計ちゃん v3.7.2z</title>
<style>
  body { font-size: 20px; font-family: sans-serif; padding: 15px; line-height: 1.4; background-color: #f9f9f9; color: #333; }
  .table-wrapper { overflow-x: auto; margin-top: 20px; background: white; border: 1px solid #999; -webkit-overflow-scrolling: touch; }
  table { border-collapse: collapse; width: max-content; font-size: 18px; }
  th, td { border: 1px solid #999; padding: 10px 8px; text-align: center; white-space: nowrap; }
  th { background-color: #eee; }
  .cut-mark { color: blue; font-weight: bold; text-decoration: line-through; opacity: 0.5; }
  .dns { color: red; font-weight: bold; }
  .total-col { color: #666; background-color: #f5f5f5; }
  .cut-col { color: blue; font-weight: bold; background-color: #e3f2fd; }
  .net-col { font-weight: bold; background-color: #fff9c4; font-size: 1.1em; border-left: 2px solid #666 !important; }
  .save-panel { background:#e3f2fd; padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid #2196F3; display: flex; gap: 5px; }
  button { font-size: 18px; padding: 15px; margin: 5px 2px; cursor: pointer; border-radius: 10px; border: 1px solid #666; background-color: #f0f0f0; font-weight: bold; touch-action: manipulation; }
  .calc-btn { background:#FF9800 !important; color:white !important; border:none !important; width:100%; margin-bottom: 10px; }
  .csv-btn { background:#2E7D32 !important; color:white !important; border:none !important; flex:1; font-size: 16px; }
  .copy-btn { background:#00B900 !important; color:white !important; border:none !important; flex:1; font-size: 16px; }
  .modal { display:none; position:fixed; top:5%; left:50%; transform:translateX(-50%); border:2px solid #666; padding:20px; background:#fff; z-index: 2000; width: 85%; max-height: 85vh; overflow-y: auto; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  textarea { width: 100%; height: 200px; font-size: 18px; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 8px; }
  .rank-row { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
  .mRankInput { font-size: 20px; padding: 12px; width: 60%; border: 1px solid #ccc; border-radius: 5px; }
  .import-area { background: #fffde7; padding: 10px; border: 1px dashed #fbc02d; border-radius: 8px; margin-top: 10px; font-size: 16px; }



<div class="import-area">
  <b>CSVから選手登録:</b><br>
  <input type="file" id="csvPartInput" accept=".csv" onchange="importParticipantsCSV(event)" style="display:none;">
  
  <button type="button" class="custom-file-btn" onclick="document.getElementById('csvPartInput').click()">
    ファイルを選択
  </button>
</div>





  .hint-text { font-size: 14px; color: #666; margin-bottom: 10px; }
</style>
</head>
<body>





<h3>集計ちゃん <span style="font-size:0.7em;">v3.7.2z by Popolo App.com</span></h3>

<div class="save-panel">
  <button onclick="saveToFile()" style="flex:1;">集計データを保存.json</button>
  <button onclick="document.getElementById('fileInput').click()" style="flex:1;">集計データを読込.json</button>
  <button onclick="clearAllData()" style="background:#f44336; color:white; flex:0.5;">消去</button>
  <input type="file" id="fileInput" style="display:none" accept=".json" onchange="loadFromFile(event)">
</div>

<div style="background:#eee; padding:15px; border-radius:8px;">
  <select id="discipline" onchange="forceRecalc();" style="width:100%; padding:12px; font-size:20px; font-weight:bold;">
    <option value="yacht">ヨット /ウイング /カイト （付則A）</option>
    <option value="wind">ウインドサーフィン（付則B）</option>
  </select>
  <div style="margin-top:10px;">
    1枚目:<input type="number" id="cut1Heat" value="4" style="font-size:20px; width:50px;"> 
    2枚目:<input type="number" id="cut2Heat" value="7" style="font-size:20px; width:50px;">
    <button onclick="openModal('tieBreakModal')" style="padding:10px; font-size:16px; background:#607D8B; color:white; border:none; border-radius:5px;">タイ=同点 ルール解説</button>
  </div>
</div>

<div style="margin-top:15px;">
  <button onclick="openPartModal()" style="background:#f44336; color:white; width:100%;">選手名を入力・編集</button>
  <div class="import-area">
    <b>CSVから選手登録:</b><br>
    <input type="file" id="csvPartInput" accept=".csv" onchange="importParticipantsCSV(event)" style="font-size:22px; margin-top:5px;">
  </div>
  <input type="hidden" id="participantList">
  <button onclick="forceRecalc()" class="calc-btn" style="margin-top:15px;">集計表を更新</button>
  <div style="display: flex; gap:10px;">
    <button onclick="exportCSV()" class="csv-btn">CSV送信</button>
    <button onclick="copyForLine()" class="copy-btn">テキストコピー</button>
  </div>
</div>

<hr>
<div style="display: flex; flex-direction: column; gap: 5px;">
    <button onclick="openManualHeat()" style="background-color: #9C27B0; color:white; padding: 15px;">着順を1件ずつ入力</button>
    <button onclick="openBulkHeat()" style="background-color: #673AB7; color:white; padding: 15px;">着順をまとめて入力</button>
</div>

<div id="tableContainer"></div>

<div id="tieBreakModal" class="modal">
    <h3>タイブレーク＝カット後に同点だった場合の順位</h3>
    <div style="text-align: left; font-size: 16px; line-height: 1.6;">
        <div style="background:#f0f7ff; padding:10px; border-radius:5px; margin-bottom:15px; border-left:4px solid #2196F3;">
            <strong style="color:#1976D2;">RRS付則A</strong> →カットを除いて得点を良順に比較→カット含めて最終レースから逆順
        </div>
        <div style="background:#fff3e0; padding:10px; border-radius:5px; border-left:4px solid #FF9800;">
            <strong style="color:#E65100;">付則B</strong> →カットされた得点を比較→カット含めて良順比較→カット含めて最終レースから逆順
        </div>
    </div>
    <button onclick="closeModal('tieBreakModal')" style="width:100%; background:#ddd; padding:15px; margin-top:15px; font-weight:bold; border-radius:10px;">閉じる</button>
</div>

<div id="partModal" class="modal">
    <h3>選手名入力・編集</h3>
    <textarea id="partTextArea" placeholder="J1 山田太郎"></textarea>
    <button onclick="submitPartModal()" style="width:100%; background:#4CAF50; color:white; padding:15px;">反映</button>
    <button onclick="closeModal('partModal')" style="width:100%; margin-top:10px;">キャンセル</button>
</div>

<div id="manualHeatModal" class="modal">
    <h3>着順入力 (H<span class="targetHeatLabel"></span>)</h3>
    <div id="manualHeatInputs"></div>
    <button onclick="addRankInput()" style="width:100%; background:#eee; padding:15px; margin-top:10px;">+ 次の順位を追加</button>
    <button onclick="submitManualHeat()" style="width:100%; background:#4CAF50; color:white; margin-top:15px; padding:15px;">保存</button>
    <button onclick="closeModal('manualHeatModal')" style="width:100%; margin-top:10px;">キャンセル</button>
</div>

<div id="bulkHeatModal" class="modal">
    <h3>一括入力 (H<span class="targetHeatLabel"></span>)</h3>
    <p class="hint-text">着順にセールNOを改行等で入力</p>
    <textarea id="bulkHeatTextArea" style="height: 300px;"></textarea>
    <button onclick="submitBulkHeat()" style="width:100%; background:#4CAF50; color:white; margin-top:15px; padding:15px;">保存</button>
    <button onclick="closeModal('bulkHeatModal')" style="width:100%; margin-top:10px;">キャンセル</button>
</div>

<div id="heatActionModal" class="modal">
    <h3 id="heatActionTitle">操作</h3>
    <button onclick="moveHeat(-1)" style="width:45%;">←移動</button> <button onclick="moveHeat(1)" style="width:45%;">移動→</button>
    <hr>
    <p>修正方法を選択：</p>
    <button style="width:100%; background:#9C27B0; color:white;" onclick="startHeatEdit('single')">1件ずつ修正</button>
    <button style="width:100%; background:#673AB7; color:white; margin-top:5px;" onclick="startHeatEdit('bulk')">まとめて修正</button>
    <button style="width:100%; background:#f44336; color:white; margin-top:15px;" onclick="confirmDeleteHeat()">削除</button>
    <button style="width:100%; margin-top:15px;" onclick="closeModal('heatActionModal')">閉じる</button>
</div>

<script>
let results = {}; let participants = []; let heats = []; 
let targetHeatIndex = -1; let isEditMode = false; let lastScoredData = [];
const STORAGE_KEY = 'sailing_current_data_w';

function openModal(id) { document.getElementById(id).style.display = 'block'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }

function forceRecalc() { applyParticipantsFromInput(); updateTable(); saveToLocal(); }

function saveToLocal() { 
  const data = { 
    results, heats, 
    participantList: document.getElementById('participantList').value, 
    discipline: document.getElementById('discipline').value, 
    cut1: document.getElementById('cut1Heat').value, 
    cut2: document.getElementById('cut2Heat').value 
  }; 
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); 
}

function loadFromLocal() { 
  const saved = localStorage.getItem(STORAGE_KEY) || localStorage.getItem('sailing_current_data');
  if (saved) { 
    try {
      const data = JSON.parse(saved); 
      results = data.results||{}; heats = data.heats||[]; 
      document.getElementById('participantList').value = data.participantList||""; 
      document.getElementById('discipline').value = data.discipline||"yacht"; 
      document.getElementById('cut1Heat').value = data.cut1||"4"; 
      document.getElementById('cut2Heat').value = data.cut2||"7"; 
      forceRecalc();
    } catch(e) { console.error(e); }
  } 
}

function loadFromFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  const r = new FileReader();
  r.onload = (e) => {
    try {
      const d = JSON.parse(e.target.result);
      results = d.results; heats = d.heats;
      document.getElementById('participantList').value = d.participantList;
      forceRecalc(); alert("読込完了");
    } catch(err) { alert("エラー"); }
  };
  r.readAsText(file);
}

function saveToFile() {
  saveToLocal();
  const blob = new Blob([localStorage.getItem(STORAGE_KEY)], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `sailing_backup_${new Date().getTime()}.json`;
  a.click();
}

function applyParticipantsFromInput(){
  const text = document.getElementById('participantList').value.trim();
  if(!text) { participants=[]; return; }
  participants = text.split(',').map(item => { 
    item = item.trim(); 
    const spaceMatch = item.match(/[\s　]/);
    if (spaceMatch) {
      const splitIdx = spaceMatch.index;
      return { no: item.substring(0, splitIdx).trim(), fullName: item.substring(splitIdx).trim() }; 
    } else { return { no: item, fullName: item }; }
  }).filter(p => p.no !== "");
  const dns = participants.length + 1;
  participants.forEach(p => { 
    if(!results[p.no]) results[p.no] = Array(heats.length).fill(dns); 
    while(results[p.no].length < heats.length) results[p.no].push(dns);
  });
}

function openPartModal() { 
  document.getElementById('partTextArea').value = participants.map(p => `${p.no} ${p.fullName}`).join('\n'); 
  openModal('partModal'); 
}
function submitPartModal() { 
  document.getElementById('participantList').value = document.getElementById('partTextArea').value.split('\n').filter(l=>l.trim()).join(', '); 
  forceRecalc(); closeModal('partModal'); 
}

// --- 1件ずつ入力ロジック ---
function addRankInput(pNo = ""){
  const container = document.getElementById('manualHeatInputs');
  const div = document.createElement('div');
  div.className = 'rank-row';
  div.innerHTML = `<span>${container.querySelectorAll('.rank-row').length + 1}位:</span><input type="text" class="mRankInput" value="${pNo}" enterkeyhint="next" autocorrect="off">`;
  container.appendChild(div);
  const input = div.querySelector('input');
  input.addEventListener('keydown', (e) => { if(e.key==='Enter'){ e.preventDefault(); if(input.value.trim()!=="") addRankInput(); else submitManualHeat(); } });
  setTimeout(() => input.focus(), 100);
}

function openManualHeat(){
  const container = document.getElementById('manualHeatInputs');
  container.innerHTML = '';
  document.querySelectorAll('.targetHeatLabel').forEach(el => el.innerText = isEditMode ? targetHeatIndex + 1 : heats.length + 1);
  if(isEditMode) {
    let entries = participants.map(p => ({no: p.no, r: results[p.no][targetHeatIndex]})).filter(e => e.r <= participants.length).sort((a,b)=>a.r-b.r);
    if(entries.length > 0) entries.forEach(e => addRankInput(e.no)); else addRankInput();
  } else { addRankInput(); }
  openModal('manualHeatModal');
}

function submitManualHeat(){
  const inputs = document.getElementsByClassName('mRankInput');
  const pts = {}; let rk = 1;
  for(let i=0; i<inputs.length; i++){
    let val = inputs[i].value.trim().toUpperCase();
    if(val!==""){
      const realP = participants.find(p => p.no.toUpperCase() === val);
      if(realP) { pts[realP.no] = rk; rk++; }
    }
  }
  processSave(pts);
  closeModal('manualHeatModal');
}

// --- まとめて入力ロジック ---
function openBulkHeat(){
  const textArea = document.getElementById('bulkHeatTextArea');
  document.querySelectorAll('.targetHeatLabel').forEach(el => el.innerText = isEditMode ? targetHeatIndex + 1 : heats.length + 1);
  if(isEditMode) {
    let entries = participants.map(p => ({no: p.no, r: results[p.no][targetHeatIndex]})).filter(e => e.r <= participants.length).sort((a,b)=>a.r-b.r);
    textArea.value = entries.map(e => e.no).join('\n');
  } else { textArea.value = ''; }
  openModal('bulkHeatModal');
  setTimeout(() => textArea.focus(), 100);
}

function submitBulkHeat(){
  const text = document.getElementById('bulkHeatTextArea').value.trim();
  const lines = text.split(/[\s,　\n]+/).filter(l => l.trim() !== "");
  const pts = {}; let rk = 1;
  lines.forEach(val => {
    const upVal = val.toUpperCase();
    const realP = participants.find(p => p.no.toUpperCase() === upVal || p.fullName === val);
    if(realP && !pts[realP.no]) { pts[realP.no] = rk; rk++; }
  });
  processSave(pts);
  closeModal('bulkHeatModal');
}

// 共通保存処理
function processSave(ptsMap) {
  const dns = participants.length + 1;
  if(isEditMode){
    participants.forEach(p => results[p.no][targetHeatIndex] = ptsMap[p.no] || dns);
  } else {
    heats.push("H");
    participants.forEach(p => {
      if(!results[p.no]) results[p.no] = [];
      results[p.no].push(ptsMap[p.no] || dns);
    });
  }
  isEditMode = false; forceRecalc();
}

function openHeatActionModal(i) { targetHeatIndex = i; document.getElementById('heatActionTitle').innerText = `H${i+1} 操作`; openModal('heatActionModal'); }
function startHeatEdit(mode) { 
  isEditMode=true; closeModal('heatActionModal'); 
  if(mode === 'bulk') openBulkHeat(); else openManualHeat(); 
}
function confirmDeleteHeat() { if(confirm("削除？")) { heats.splice(targetHeatIndex, 1); for(let no in results) results[no].splice(targetHeatIndex, 1); forceRecalc(); } closeModal('heatActionModal'); }
function moveHeat(direction) {
  let n = targetHeatIndex + direction; if(n<0||n>=heats.length) return;
  for(let k in results){ let t=results[k][targetHeatIndex]; results[k][targetHeatIndex]=results[k][n]; results[k][n]=t; }
  forceRecalc(); closeModal('heatActionModal');
}

function updateTable(){
  const disc = document.getElementById('discipline').value;
  const c1 = parseInt(document.getElementById('cut1Heat').value)||99, c2 = parseInt(document.getElementById('cut2Heat').value)||99;
  const dns = participants.length + 1;
  let sd = participants.map(p => {
    let pts = (results[p.no] || []).map(v => (v > participants.length ? dns : v));
    let sfc = pts.map((val, idx) => ({val, idx})).sort((a,b) => b.val - a.val);
    let cc = (pts.length >= c2) ? 2 : (pts.length >= c1 ? 1 : 0);
    let ci = sfc.slice(0, cc).map(x => x.idx);
    let net = 0, ncp = [], cp = [];
    pts.forEach((pt, i) => { if(ci.includes(i)) cp.push(pt); else { net += pt; ncp.push(pt); } });
    return { no: p.no, name: p.fullName, pts, net, cp, ncp, total: pts.reduce((a,b)=>a+b,0) };
  });
  sd.sort((a,b) => {
    if(a.net !== b.net) return a.net - b.net;
    if(disc==='yacht'){
      let aS = [...a.ncp].sort((x,y)=>x-y), bS = [...b.ncp].sort((x,y)=>x-y);
      for(let i=0; i<aS.length; i++) if(aS[i] !== bS[i]) return aS[i] - bS[i];
    } else {
      let acS = [...a.cp].sort((x,y)=>x-y), bcS = [...b.cp].sort((x,y)=>x-y);
      for(let i=0; i<acS.length; i++) if(acS[i] !== bcS[i]) return acS[i] - bcS[i];
      let apS = [...a.pts].sort((x,y)=>x-y), bpS = [...b.pts].sort((x,y)=>x-y);
      for(let i=0; i<apS.length; i++) if(apS[i] !== bpS[i]) return apS[i] - bpS[i];
    }
    for(let i=a.pts.length-1; i>=0; i--) if(a.pts[i] !== b.pts[i]) return a.pts[i] - b.pts[i];
    return 0;
  });
  lastScoredData = sd;
  let html = `<table><tr><th>Rank</th><th>No.</th><th>Name</th>` + heats.map((_,i)=>`<th onclick="openHeatActionModal(${i})">H${i+1}</th>`).join("");
  html += `<th class="total-col">Total</th><th class="cut-col">Cut1</th><th class="cut-col">Cut2</th><th class="net-col">Net</th></tr>`;
  sd.forEach((r, idx) => {
    html += `<tr><td>${idx+1}</td><td>${r.no}</td><td style="text-align:left;">${r.name}</td>`;
    let sfc = r.pts.map((v, i) => ({v, i})).sort((a,b) => b.v - a.v);
    let cc = (r.pts.length >= c2) ? 2 : (r.pts.length >= c1 ? 1 : 0);
    let ci = sfc.slice(0, cc).map(x => x.i);
    r.pts.forEach((pt, i) => html += `<td class="${ci.includes(i)?'cut-mark':''} ${pt>=dns?'dns':''}">${pt}</td>`);
    html += `<td class="total-col">${r.total}</td><td class="cut-col">${r.cp[0]||'-'}</td><td class="cut-col">${r.cp[1]||'-'}</td><td class="net-col">${r.net}</td></tr>`;
  });
  document.getElementById('tableContainer').innerHTML = `<div class="table-wrapper">${html}</table></div>`;
}

function copyForLine() {
  let t = `【速報】全${heats.length}戦\n`;
  lastScoredData.forEach((r, idx) => {
    const dnsVal = participants.length + 1;
    const heatScores = r.pts.map(v => v >= dnsVal ? "dns" : v).join(",");
    t += `${idx+1}位 ${r.no} ${r.name} (${heatScores}) Net:${r.net}\n`;
  });
  navigator.clipboard.writeText(t).then(() => alert("コピー完了"));
}

function exportCSV() {
  let csv = "\uFEFFRank,No.,Name," + heats.map((_,i)=>`H${i+1}`).join(",") + ",Total,Cut1,Cut2,Net\n";
  lastScoredData.forEach((r, idx) => { csv += `${idx+1},${r.no},"${r.name}",${r.pts.join(",")},${r.total},${r.cp[0]||""},${r.cp[1]||""},${r.net}\n`; });
  const b = new Blob([csv], { type: 'text/csv' });
  if (navigator.share) navigator.share({ files: [new File([b], "result.csv", { type: 'text/csv' })] });
}

function clearAllData() { if(confirm("消去？")) { localStorage.clear(); location.reload(); } }

window.onload = loadFromLocal;
function importParticipantsCSV(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const lines = e.target.result.split(/\r\n|\n/);
    let list = [];
    lines.forEach(line => {
      if (line.trim()) {
        const parts = line.split(/[,\t]/);
        if (parts.length >= 2) list.push(`${parts[0].trim()} ${parts[1].trim()}`);
        else list.push(line.trim());
      }
    });
    document.getElementById('participantList').value = list.join(', ');
    forceRecalc();
    alert("読込完了");
  };
  reader.readAsText(file);
}
</script>
</body>
</html>